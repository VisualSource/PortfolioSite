var te=Object.defineProperty;var xt=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var _t=(n,t,e)=>t in n?te(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Mt=(n,t)=>{for(var e in t||(t={}))ee.call(t,e)&&_t(n,e,t[e]);if(xt)for(var e of xt(t))ie.call(t,e)&&_t(n,e,t[e]);return n};var o=(n,t,e)=>(_t(n,typeof t!="symbol"?t+"":t,e),e);import{E as se,l as rt,J as ne,L as ae,G as re,O as oe,M as le,I as ce,D as he,a as ue,b as de,S as fe,c as Dt,C as Y,d as me,e as pe,Q as ge,f as ye,V as gt,g as we,h as ve,i as Ee,R as Ut,B as be,j as Te,T as _e,W as Ie,k as Se,m as Ne,n as Ae,F as Oe,H as Ce,o as Re,p as Le,r as M,q as tt,s as Pt,t as It,u as St,v as Nt,w as D,x as ot,y as At,z as yt,A as C,K as et,N as R,P as wt,U as Ot,X as ke,Y as it,Z as xe,_ as X,$ as Me,a0 as De,a1 as st,a2 as Ue,a3 as vt,a4 as Pe,a5 as $e,a6 as Fe,a7 as He,a8 as je,a9 as Ve,aa as We,ab as Ct,ac as $t,ad as Ft,ae as Be}from"./vendor.89b6cd42.js";const Je=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}};Je();var _;(function(n){n.LOG="LOG",n.ERROR="ERROR",n.ASSET_LOADER="ASSET_LOADER",n.OBJECT="OBJECT",n.INTERACTION="INTERACTION",n.UNIT="UNIT",n.SOUND="SOUND",n.ACTION="ACTION"})(_||(_={}));var Ht;(function(n){n[n.PLAY=0]="PLAY",n[n.STOP=1]="STOP",n[n.PAUSE=2]="PAUSE"})(Ht||(Ht={}));var $;(function(n){n[n.MOVE=0]="MOVE",n[n.ATTACK=1]="ATTACK",n[n.GENERATE=2]="GENERATE",n[n.HIDE_SELECTOR=3]="HIDE_SELECTOR"})($||($={}));var A;(function(n){n[n.DESELECTION=0]="DESELECTION",n[n.SELECTION=1]="SELECTION",n[n.RESET=2]="RESET",n[n.UNIT_SELECT=3]="UNIT_SELECT",n[n.TILE_SELECT=4]="TILE_SELECT"})(A||(A={}));var jt;(function(n){n[n.ASSETS_LOADED=0]="ASSETS_LOADED",n[n.ASSETS_INSTALLED=1]="ASSETS_INSTALLED",n[n.ASSETS_INSTALL_ERROR=2]="ASSETS_INSTALL_ERROR",n[n.ASSETS_LOAD_ERROR=3]="ASSETS_LOAD_ERROR",n[n.ASSETS_UPDATED=4]="ASSETS_UPDATED",n[n.ASSETS_START_UNINSTALL=5]="ASSETS_START_UNINSTALL",n[n.ASSETS_START_INSTALL=6]="ASSETS_START_INSTALL",n[n.CHECKING_FOR_UPDATE=7]="CHECKING_FOR_UPDATE",n[n.ASSETS_INIT_START=8]="ASSETS_INIT_START",n[n.ASSETS_INIT_END=9]="ASSETS_INIT_END"})(jt||(jt={}));var U;(function(n){n[n.RECOVER=0]="RECOVER",n[n.HEAL=1]="HEAL",n[n.SPAWN=2]="SPAWN",n[n.CREATE=3]="CREATE",n[n.DISBAND=4]="DISBAND",n[n.DESTORY=5]="DESTORY",n[n.GATHER=6]="GATHER"})(U||(U={}));const ft=class extends se{constructor(){if(ft.INSTANCE)return ft.INSTANCE;super();ft.INSTANCE=this}on(t,e){return this.addEventListener(t,e)}off(t,e){return this.removeEventListener(t,e)}onId(t,e){return this.addEventListener(t.name,i=>{i.id===t.id&&e(i)})}offId(t,e){return this.removeEventListener(t.name,i=>{i.id===t.id&&e(i)})}emit(t){return this.dispatchEvent(t)}};let q=ft;o(q,"INSTANCE",null);const Ge=n=>{const t=[],e=new Set;for(const i of n){let s=i,a=0;for(;e.has(s);)s=i+"."+ ++a;e.add(s),t.push(s)}return t},Ye=(n,t)=>{const e={};for(const i of n.mappings)for(const s of i.variants)e[t[s]]={material:null,gltfMaterialIndex:i.material};return e},Et=n=>n.material!==void 0&&n.userData&&n.userData.variantMaterials,Vt=(n,t,e)=>{e(n,t);for(let i=0;i<n.children.length;i++)Vt(n.children[i],t.children[i],e)},Wt=(n,t)=>{t.userData.variantMaterials!==void 0&&(n.userData.variantMaterials=Object.assign({},t.userData.variantMaterials)),t.userData.originalMaterial!==void 0&&(n.userData.originalMaterial=t.userData.originalMaterial)};class qe{constructor(t){o(this,"name","KHR_materials_variants");this.parser=t}afterRoot(t){const e=this.parser,i=e.json;if(!i.extensions||!i.extensions[this.name])return null;const a=i.extensions[this.name].variants||[],r=Ge(a.map(u=>u.name));for(const u of t.scenes)u.traverse(f=>{const p=e.associations.get(f);if(!p||p.meshes===void 0||p.primitives===void 0)return;const T=i.meshes[p.meshes].primitives[p.primitives].extensions;!T||!T[this.name]||(f.userData.variantMaterials=Ye(T[this.name],r))});t.userData.variants=r,t.functions=t.functions||{};const c=async(u,f,p)=>{u.userData.originalMaterial||(u.userData.originalMaterial=u.material);const w=u.material;let S=null;if(f===null||!u.userData.variantMaterials[f])u.material=u.userData.originalMaterial,e.associations.has(u.material)&&(S=e.associations.get(u.material).index);else{const T=u.userData.variantMaterials[f];T.material?(u.material=T.material,T.gltfMaterialIndex!==void 0&&(S=T.gltfMaterialIndex)):(S=T.gltfMaterialIndex,u.material=await e.getDependency("material",S),e.assignFinalMaterial(u),T.material=u.material)}p!==null&&p(u,w,S)},h=u=>{const f=u.material,p=u.userData.variantMaterials,w=[];for(const S in p){const T=p[S];if(T.material)continue;const j=T.gltfMaterialIndex;w.push(e.getDependency("material",j).then(k=>{u.material=k,e.assignFinalMaterial(u),p[S].material=u.material}))}return Promise.all(w).then(()=>{u.material=f})};return t.functions.selectVariant=(u,f,p=!0,w=null)=>{const S=[];return p?u.traverse(T=>Et(T)&&S.push(c(T,f,w))):Et(u)&&S.push(c(u,f,w)),Promise.all(S)},t.functions.ensureLoadVariants=(u,f=!0)=>{const p=[];return f?u.traverse(w=>Et(w)&&p.push(h(w))):Et(u)&&p.push(h(u)),Promise.all(p)},t.functions.copyVariantMaterials=(u,f,p=!0)=>{p?Vt(u,f,(w,S)=>Wt(w,S)):Wt(u,f)},null}}const Ke={glb:"model/gltf-binary",gltf:"model/gltf+json",obj:"model/obj",mtl:"model/mtl",json:"application/json",webm:"audio/webm",mp3:"audio/mp3"},mt=class{constructor(t=!1){o(this,"assets",new Map);o(this,"audio",new Map);o(this,"context");if(mt.INSTANCE)return mt.INSTANCE;mt.INSTANCE=this,t&&this.init()}async getAsset(t,e=0,i="gltf"){const s=this.assets.get(t);if(!s)throw new Error(`Failed to get asset "${t}"`);if(i==="obj")return s.children[e];if(i==="gltf"&&(e==null?void 0:e.child)!=null){const a=s.scene.children[e.child].clone(!0);return s.functions.copyVariantMaterials(a,s.scene.children[e.child]),await s.functions.selectVariant(a,e.name),a}return s.scene.children[e]}getVarient(t){const e=this.assets.get(t);if(!e)throw new Error(`Unkown asset "${t}".`);return e}playSound(t){const e=this.audio.get(t);if(!e)throw new Error("Failed to get audio asset");const i=this.context.createBufferSource();i.buffer=e,i.connect(this.context.destination),i.start(0)}async init(){try{const t=window.AudioContext||window.webkitAudioContext;this.context=new t,rt.config({name:"polytopia",version:1,description:"Polytopia file storage",storeName:"polytopia"}),localStorage.getItem("pak_installed")===null&&await this.install(),await this.load()}catch(t){console.error(t)}}async decodeAudio(t){return new Promise((e,i)=>{this.context.decodeAudioData(t,s=>{e(s)},s=>{i(s)})})}async install(t="raw.zip",e=void 0){var i;try{const s=new ne,r=await(await fetch(`/demo8/${t}`)).blob(),c=await s.loadAsync(r),h=JSON.parse(await((i=c.file("manifest.json"))==null?void 0:i.async("string")));await rt.removeItem("pak");const u=new Map;for await(const f of this.cache(h,c))u.set(f.name,f);await rt.setItem("pak",u),e?localStorage.setItem("pak_installed",e.toString()):localStorage.setItem("pak_installed","2")}catch(s){console.error("INSTALL ERROR |",s)}}async*cache(t,e){var s,a,r;let i=0;for(;i<t.length;){const c=t[i].file,h=c.split(".").pop();if(!h)throw new Error(`File: ${c} is missing a file extention`);if(!e.files[c])throw new Error(`Failed to find file for NAME: ${t[i].name} | PATH: ${c} | RESOURCE: ${(s=t[i])==null?void 0:s.resource}`);yield{blob:new Blob([await e.files[c].async("uint8array")],{type:Ke[h]}),date:new Date().toISOString(),name:t[i].name,resourceItem:(r=(a=t[i])==null?void 0:a.resource)!=null?r:null},i++}return null}async*loadAsset(t){const e=new ae(void 0,void 0,s=>{console.error("Loader Error |",s)}),i=new re(e);i.register(s=>new qe(s));for(const[s,a]of t)switch(a.blob.type){case"model/gltf-binary":case"model/gltf+json":{const r=await i.parseAsync(await a.blob.arrayBuffer(),"");"functions"in r&&await r.functions.ensureLoadVariants(r.scene.children[0]),yield{type:"asset",data:{name:s,asset:r}};break}case"model/obj":{yield await new Promise(async(r,c)=>{try{if(!a.resourceItem)throw new Error(`Failed to load ${a.resourceItem} for ${a.name}`);const h=t.get(a.resourceItem);if(!h)throw new Error(`Loader (MTL) | Failed to load ${s} resource`);const u=await h.blob.text();if(!u)throw new Error(`Loader (MTL) | Failed to load asset ${a.resourceItem}`);const f=new oe(e),p=new le(e).parse(u,"");f.setMaterials(p);const w=f.parse(await a.blob.text());r({type:"asset",data:{name:s,asset:w}})}catch(h){c(h)}});break}case"application/json":break;case"audio/webm":case"audio/mp3":{yield await new Promise(async(r,c)=>{try{const h=await a.blob.arrayBuffer(),u=await this.decodeAudio(h);r({type:"sound",data:{name:s,asset:u}})}catch(h){c(h)}});break}}return null}async load(){const t=await rt.getItem("pak");if(!t)throw new Error("Failed to load asset.");for await(const e of this.loadAsset(t))e.type==="asset"?this.assets.set(e.data.name,e.data.asset):this.audio.set(e.data.name,e.data.asset)}async reinstall(){localStorage.removeItem("pak_installed"),rt.removeItem("pack"),await this.install()}};let Rt=mt;o(Rt,"INSTANCE",null);class bt extends ce{constructor(t,e,i,s,a=4){super(e,i,15**2);o(this,"events",new q);o(this,"dummy",new ue);this.name=t,this.data=s,this.WORLD_TILE_OFFSET=a,this.instanceMatrix.setUsage(he),this.update()}setRotation(t,e){this.data[t].rotation=e,this.dummy.rotation.set(0,e,0),this.dummy.updateMatrix(),this.setMatrixAt(t,this.dummy.matrix)}setPostion(t,e,i,s){this.data[t].x=e,this.data[t].y=i,this.data[t].z=s,this.dummy.position.set(e*this.WORLD_TILE_OFFSET,i*this.WORLD_TILE_OFFSET,s*this.WORLD_TILE_OFFSET),this.dummy.updateMatrix(),this.setMatrixAt(t,this.dummy.matrix)}getItem(t){if(t>this.count||t<0)throw new Error("Index out of bounds");return this.data[t]}getItemById(t){return this.data.find(e=>e.id===t)}editInstance(t,e){const i=this.getItemById(t);if(!!i){for(const s in e)i[s]=e[s];this.update()}}createInstance(t){this.data.push(t),this.update()}removeInstanceById(t){this.removeInstance(this.data.findIndex(e=>e.id===t))}removeInstance(t){if(t<0||t>=this.data.length)throw new Error("Index out of bounds");const e=this.data.length-1;let i=this.data[t];for(let s=t;s<e;s++)this.data[s]=this.data[s+1];return this.data.length=e,this.update(),i}removeAll(){this.data=[],this.count=0,this.update()}update(){this.count=this.data.length;for(let t=0;t<this.data.length;t++)this.data[t].index=t,this.setPostion(t,this.data[t].x,this.data[t].y,this.data[t].z),this.setRotation(t,this.data[t].rotation);this.instanceMatrix.needsUpdate=!0}}var V;(function(n){n[n.BASE=0]="BASE",n[n.TOP=1]="TOP",n[n.SELECTOR=2]="SELECTOR",n[n.UNIT=3]="UNIT",n[n.UI=4]="UI"})(V||(V={}));class Ze extends de{constructor(t,e,i,s,a){super(s,a);o(this,"isGameObject",!0);this.name=t,this.tile_owner=e,this.world_position=i,this.position.set(i.row*4,0,i.col*4),this.renderOrder=V.BASE}clean(){for(const t of this.children)!(t==null?void 0:t.isInstancedMesh)||t.removeAll()}getObjectInstance(t){const e=this.getObjectByName(t);if(!!e)return e}createObjectInstance(t,e,i){const s=new bt(t,e,i,[],1);return s.renderOrder=V.TOP,this.add(s),s}removeObjectInstance(t){const e=this.getObjectByName(t);!e||this.remove(e)}}class Xe extends fe{constructor(){super();o(this,"levelname","overworld");this.name="polytopia"}activeLevelReady(){return this.getObjectByName(this.levelname)||this.createLevel(this.levelname),!0}getLevel(t){return this.getObjectByName(t)}getActiveLevel(){return this.getObjectByName(this.levelname)}getOrCreateActiveLevel(){return this.getLevelOrCreate(this.levelname)}getLevelOrCreate(t){const e=this.getLevel(t);return e||this.createLevel(t)}createLevel(t){const e=new Dt;return e.name=t,this.add(e),e}getObject(t){const i=this.getActiveLevel().getObjectByName(t);return i||null}createCityInstance(t,e,i,s=void 0,a=void 0){const r=new Ze(t,i,e,s,a);return this.getActiveLevel().add(r),r}createObjectInstance(t,e=void 0,i=void 0){const s=new bt(t,e,i,[]);return this.getActiveLevel().add(s),s}}function Qe(){var t,e;const n=(e=(t=navigator.userAgent)!=null?t:navigator.vendor)!=null?e:window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(n)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(n.substr(0,4))}/**
 * @name touchtap-event
 * @description A lightweight JavaScript library that adds a touchtap custom event to the document which can be listened to on any element. This will only emit an event on touch enabled devices or those emulating touch devices. It works by listening to various touch events to dispatch the event if the touchstart and touchend events were in approximately the same position and took <= 200ms.
 * @version V2.0.1
 * @event touchtap 
 * @author Daniel Imms
 * @see http://github.com/Tyriar/touchtap-event
 * @copyright Copyright 2014 Daniel Imms
 * @license MIT license <http://github.com/Tyriar/touchtap-event/blob/master/LICENSE>
 * @modifed VisualSource
 */class ze{constructor(t=document){o(this,"touchTapEvent");o(this,"isTapLength");o(this,"tapLengthTimeout");o(this,"startPosition",{x:-1,y:-1});o(this,"currentPosition",{x:-1,y:-1});try{this.touchstart=this.touchstart.bind(this),this.touchend=this.touchend.bind(this),this.touchmove=this.touchmove.bind(this),this.touchTapEvent=document.createEvent("Event"),this.touchTapEvent.initEvent("touchtap",!0,!0),t.addEventListener("touchstart",this.touchstart,!1),t.addEventListener("touchend",this.touchend,!1),t.addEventListener("touchcancel",this.touchend,!1),t.addEventListener("touchmove",this.touchmove,!1)}catch{}}dispose(t=document){t.removeEventListener("touchstart",this.touchstart,!1),t.removeEventListener("touchend",this.touchend,!1),t.removeEventListener("touchcancel",this.touchend,!1),t.removeEventListener("touchmove",this.touchmove,!1)}getTouchObject(t){return t.originalEvent&&t.originalEvent.targetTouches?t.originalEvent.targetTouches[0]:t.targetTouches?t.targetTouches[0]:t}approximatelyEqual(t,e){return Math.abs(t-e)<2}touchstart(t){const e=this.getTouchObject(t);this.startPosition.x=e.pageX,this.startPosition.y=e.pageY,this.currentPosition.x=e.pageX,this.currentPosition.y=e.pageY,this.isTapLength=!0,this.tapLengthTimeout&&clearTimeout(this.tapLengthTimeout),this.tapLengthTimeout=setTimeout(()=>{this.isTapLength=!1},200)}touchend(t){this.isTapLength&&this.approximatelyEqual(this.startPosition.x,this.currentPosition.x)&&this.approximatelyEqual(this.startPosition.y,this.currentPosition.y)&&(this.touchTapEvent.customData={touchX:this.currentPosition.x,touchY:this.currentPosition.y},t.target.dispatchEvent(this.touchTapEvent))}touchmove(t){const e=this.getTouchObject(t);this.currentPosition.x=e.pageX,this.currentPosition.y=e.pageY}}class ti{constructor(t){o(this,"controls");o(this,"renderer");o(this,"composer");o(this,"camera");o(this,"raycaster",new Ut);o(this,"textureLoader",new _e);o(this,"frustumSize",1e3);o(this,"touch",null);o(this,"hover",{INTERSECTION:null,pointer:new gt});o(this,"is_mobile",Qe());o(this,"scene");o(this,"events",new q);o(this,"selection_mobile",t=>{this.selection_handler(new gt(t.customData.touchX/window.innerWidth*2-1,-(t.customData.touchY/window.innerHeight)*2+1))});o(this,"selection_normal",t=>{this.selection_handler(new gt(t.clientX/window.innerWidth*2-1,-(t.clientY/window.innerHeight)*2+1))});o(this,"onMouseMove",t=>{this.hover.pointer.x=t.clientX/window.innerWidth*2-1,this.hover.pointer.y=-(t.clientY/window.innerHeight)*2+1});o(this,"resize",()=>{const t=window.innerWidth/window.innerHeight;this.camera.left=-this.frustumSize*t/2,this.camera.right=this.frustumSize*t/2,this.camera.top=this.frustumSize/2,this.camera.bottom=-this.frustumSize/2,this.composer.setSize(window.innerWidth,window.innerHeight),this.composer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight,!0),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.updateProjectionMatrix()});o(this,"animationLoop",t=>{this.controls.update(t),this.composer.render(t),this.hoverUpdate()});this.canvas=t,Y.install({THREE:{MOUSE:me,MathUtils:pe,Quaternion:ge,Spherical:ye,Vector2:gt,Vector3:we,Vector4:ve,Matrix4:Ee,Raycaster:Ut,Box3:be,Sphere:Te}})}init(){this.renderer=new Ie({antialias:!0,canvas:this.canvas}),this.scene=new Xe;const t=window.innerWidth/window.innerHeight;this.camera=new Se(this.frustumSize*t/-2,this.frustumSize*t/2,this.frustumSize/2,this.frustumSize/-2,1,1e3),this.composer=new Ne(this.renderer),this.composer.addPass(new Ae(this.scene,this.camera)),this.composer.setSize(window.innerWidth,window.innerHeight),this.composer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight,!0),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.lookAt(this.scene.position),this.controls=new Y(this.camera,this.renderer.domElement),this.controls.setPosition(0,0,5),this.controls.maxZoom=30,this.controls.minZoom=10,this.controls.zoom(10,!1),this.controls.azimuthAngle=3.913,this.controls.polarAngle=.825,this.controls.mouseButtons.left=Y.ACTION.TRUCK,this.controls.mouseButtons.right=Y.ACTION.NONE,this.controls.mouseButtons.middle=Y.ACTION.NONE,this.controls.touches.one=Y.ACTION.TOUCH_TRUCK,this.controls.touches.two=Y.ACTION.TOUCH_ZOOM,this.controls.touches.three=Y.ACTION.NONE;const e=this.textureLoader.load(`/demo8/${this.is_mobile?"background/mobile_bg.jpg":"background/desktop_bg.jpg"}`);this.scene.background=e,this.scene.fog=new Oe(0),document.addEventListener("resize",this.resize,!0),this.renderer.domElement.addEventListener("pointermove",this.onMouseMove,!0),this.is_mobile?(this.touch=new ze(this.renderer.domElement),this.renderer.domElement.addEventListener("touchtap",this.selection_mobile,!0)):this.renderer.domElement.addEventListener("click",this.selection_normal,!0);const i=new Dt;i.name="Lights";const s=new Ce;s.position.set(0,50,0),i.add(s);const a=new Re;a.position.set(-1,1.75,1),a.position.multiplyScalar(30),i.add(a),this.scene.add(i),this.renderer.setAnimationLoop(this.animationLoop)}destory(){var t;document.removeEventListener("resize",this.resize),this.renderer.domElement.removeEventListener("pointermove",this.onMouseMove),this.renderer.domElement.removeEventListener("touchtap",this.selection_mobile),this.renderer.domElement.removeEventListener("click",this.selection_normal),(t=this.touch)==null||t.dispose(this.renderer.domElement),this.renderer.dispose()}selection_handler(t){this.raycaster.setFromCamera(t,this.camera);const e=this.scene.getActiveLevel();if(!e){console.error("Selection: Failed to find World Group");return}const i=this.raycaster.intersectObjects(e.children);if(!(i.length>0)){this.events.emit({type:_.INTERACTION,id:A.DESELECTION,data:{}});return}let{object:s,instanceId:a}=i[0];if(s==null?void 0:s.isInstancedMesh){const r=s.getItem(a);this.events.emit({type:_.INTERACTION,id:A.TILE_SELECT,data:{type:r.type,owner:r.owner,id:r.id}});return}!(s==null?void 0:s.isGameObject)||this.events.emit({type:_.INTERACTION,id:A.TILE_SELECT,data:{type:"tile",owner:s.tile_owner,id:s.uuid}})}hoverUpdate(){if(this.is_mobile)return;this.raycaster.setFromCamera(this.hover.pointer,this.camera);const t=this.scene.getActiveLevel();if(!t)return;const e=this.raycaster.intersectObjects(t.children);e.length>0?this.hover.INTERSECTION!=e[0].object&&(this.hover.INTERSECTION=e[0].object,this.renderer.domElement.style.cursor="pointer"):(this.hover.INTERSECTION&&(this.renderer.domElement.style.cursor="default"),this.hover.INTERSECTION=null)}moveCameraTo(t,e){this.controls.moveTo(t*4,0,e*4,!0)}}const ei=1/3,W=(n,t,e,i,s)=>({default:n,"xin-xi":t,imperius:e,bardur:i,oumaji:s}),O={ocean:W(.25,0,0,0,0),water:W(.5,0,0,0,0),forest:W(.4,1,1,1,.1),mountain:W(.15,2,1,1,1),metal:W(.5,1,1,1,1),fruit:W(.5,1,1,1.5,1),crop:W(.5,1,1,.1,1),game:W(.5,1,1,2,1),fish:W(.5,1,1,1,1),whale:W(.4,1,1,1,1)},ii=n=>n<O.ocean.default?"OCEAN":n<O.water.default?"WATER":"LAND";class Lt{constructor(t){o(this,"_data",[]);this.size=t;for(let e=0;e<this.size;e++)this._data.push([])}set(t,e,i){this._data[t][e]=i}get(t,e){return this._data[t][e]}isValid(t,e){if(!!this._data[t])return this._data[t][e]}*[Symbol.iterator](){for(const t of this._data)for(const e of t)yield e}}class si{static gen(t,e=11){var I,L,J,z,G,kt;let i=new Lt(e);const s=new Le,a=(l,d)=>s.noise(l,d)/2+.5;for(let l=0;l<e;l++)for(let d=0;d<e;d++)i.set(l,d,{col:d,row:l,base:ii(a(l/e-.5,d/e-.5)),metadata:{},buldings:[],tribe:"xin-xi"});let r=[],c={};for(let l of t)for(let d=2;d<e-2;d++)for(let m=2;m<e-2;m++)((I=i.isValid(d,m))==null?void 0:I.base)==="LAND"&&(c[d*e+m]=0);for(let l of t){let d=0;for(let g in c){c[g]=e;for(let b of r)c[g]=Math.min(c[g],ni(g,b,e));d=Math.max(d,c[g])}let m=0;for(let g in c)c[g]===d&&m++;let E=M.int(0,m-1);for(let g of Object.entries(c))g[1]===d&&(E===0&&r.push(parseInt(g[0])),E--)}for(let l=0;l<r.length;l++){const d=r[l]/e|0,m=r[l]%e;i.set(d,m,{base:"CITY",buldings:[],metadata:{capital:!0},tribe:t[l],row:d,col:m})}let h=[],u=[];for(let l=0;l<r.length;l++)h[l]=r[l],u[l]=[r[l]];for(;h.length!==e**2;)for(let l=0;l<t.length;l++)if((L=u[l])==null?void 0:L.length){let d=M.int(0,u[l].length-1),m=u[l][d],E=K(m,1,e),g=E.filter(b=>h.indexOf(b)===-1&&i.get(b/e|0,b%e).base!=="WATER");if(g.length||(g=E.filter(b=>h.indexOf(b)===-1)),g.length){let b=M.int(0,g.length-1),x=g[b];i.get(x/e|0,x%e).tribe=t[l],u[l].push(x),h.push(x)}else u[l].splice(d,1)}for(let l=0;l<e**2;l++)if(i.get(l/e|0,l%e)){const d=l/e|0,m=l%e;let E=i.get(d,m).tribe,g=M.float(0,1);g<O.forest.default*O.forest[E]?i.get(d,m).base="FOREST":g>1-O.mountain.default*O.mountain[E]&&(i.get(d,m).base="MOUNTAIN"),g=M.float(0,1),g<O.water[E]&&(i.get(d,m).base="OCEAN")}let f=[];for(let l=0;l<e**2;l++){let d=l/e|0,m=l%e;i.get(d,m).base==="OCEAN"||i.get(d,m).base==="MOUNTAIN"||d===0||d===e-1||m===0||m===e-1?f[l]=-1:f[l]=0}for(let l of r){f[l]=3;for(let d of K(l,1,e))f[d]=Math.max(f[d],2);for(let d of K(l,2,e))f[d]=Math.max(f[d],1)}for(;f.indexOf(0)!==-1;){let l=Bt(f.map((d,m)=>d===0?m:null).filter(d=>d!==null));f[l]=3;for(let d of K(l,1,e))f[d]=Math.max(f[d],2);for(let d of K(l,1,e))f[d]=Math.max(f[d],1)}const p=(l,d)=>f[l]===2&&M.float()<d||f[l]===1&&M.float()<d*ei;for(let l=0;l<e**2;l++){let d=l/e|0,m=l%e,E=i.get(d,m).tribe;switch(i.get(d,m).base){case"LAND":{let g=O.fruit.default*O.fruit[E],b=O.crop.default*O.crop[E];f[l]===3?(i.get(d,m).buldings.push("VILLAGE"),i.get(d,m).base="LAND"):p(l,g*(1-b/2))?i.get(d,m).buldings.push("FRUIT"):p(l,b*(1-g/2))&&i.get(d,m).buldings.push("CROP");break}case"FOREST":{f[l]===3?(i.get(d,m).buldings.push("VILLAGE"),i.get(d,m).base="LAND"):p(l,O.game.default*O.game[E])&&i.get(d,m).buldings.push("GAME");break}case"WATER":{p(l,O.fish.default*O.fish[E])&&i.get(d,m).buldings.push("FISH");break}case"OCEAN":{p(l,O.whale.default*O.whale[E])&&i.get(d,m).buldings.push("WHALE");break}case"MOUNTAIN":{p(l,O.metal.default*O.metal[E])&&i.get(d,m).buldings.push("METAL");break}}}let w=Math.round(e**2/40),S=Math.round(w/3),T=0,j=0;for(;T<w;){let l=Bt(f.map((m,E)=>m===0||m===1||m===-1?E:null).filter(m=>m!==null)),d=i.get(l/e|0,l%e).base;if(d!=="WATER"&&(j<S||d!=="OCEAN")){i.get(l/e|0,l%e).buldings.push("RUIN"),d==="OCEAN"&&j++;for(let m of K(l,1,e))f[m]=Math.max(f[m],2);T++}}const k=(l,d)=>{let m=0;for(let E of K(d,1,e))i.get(E/e|0,E%e).buldings.includes(l)&&m++;return m},Z=(l,d,m,E)=>{let g=k(l,E);for(;g<m;){let b=M.int(0,7),x=K(E,1,e),F=x[b]/e|0,H=x[b]%e;i.get(F,H).base=d,i.get(F,H).buldings=[l];for(let P of ai(x[b],e))i.get(P/e|0,P%e).base==="OCEAN"&&(i.get(P/e|0,P%e).base="WATER");g=k(l,E)}};for(let l of r)switch(i.get(l/e|0,l%e).tribe){case"imperius":{Z("FRUIT","LAND",2,l);break}case"bardur":{Z("GAME","FOREST",2,l);break}}const B=0,v=Math.PI/2,N=Math.PI,y=3*Math.PI/2;for(let l=0;l<e**2;l++){let d=l/e|0,m=l%e;const E=i.get(d,m).base;if(E==="WATER"||E==="OCEAN"){let g=4,b=B;const x=((J=i.isValid(d,m-1))==null?void 0:J.base)===E,F=((z=i.isValid(d,m+1))==null?void 0:z.base)===E,H=((G=i.isValid(d-1,m))==null?void 0:G.base)===E,P=((kt=i.isValid(d+1,m))==null?void 0:kt.base)===E;x&&g--,F&&g--,H&&g--,P&&g--,g===1?x&&F&&P?b=y:x&&P&&H?b=B:F&&P&&H?b=N:x&&F&&H&&(b=v):g===2?H&&P?(g=5,b=N):x&&F?(g=5,b=v):H&&x?b=v:H&&F?b=N:F&&P&&(b=y):g===3&&(F?b=N:x?b=B:H?b=v:P&&(b=y)),i.get(d,m).metadata={model_id:g,rotation:b}}}return i}}function Bt(n){let t=M.int(0,n.length-1);return n[t]}function ni(n,t,e){let i=n%e,s=n/e|0,a=t%e,r=t/e|0;return Math.max(Math.abs(i-a),Math.abs(s-r))}function K(n,t,e){let i=[],s=n/e|0,a=n%e,r=s-t;if(r>=0&&r<e)for(let h=a-t;h<a+t;h++)h>=0&&h<e&&i.push(r*e+h);if(r=s+t,r>=0&&r<e)for(let h=a+t;h>a-t;h--)h>=0&&h<e&&i.push(r*e+h);let c=a-t;if(c>=0&&c<e)for(let h=s+t;h>s-t;h--)h>=0&&h<e&&i.push(h*e+c);if(c=a+t,c>=0&&c<e)for(let h=s-t;h<s+t;h++)h>=0&&h<e&&i.push(h*e+c);return i}function ai(n,t){let e=[],i=n/t|0,s=n%t;return s>0&&e.push(n-1),s<t-1&&e.push(n+1),i>0&&e.push(n-t),i<t-1&&e.push(n+t),e}function lt(n){return n[0].toUpperCase()+n.toLowerCase().substring(1)}const Jt={0:"ZERO",1:"ONE",2:"TWO",3:"THREE",4:"FOUR",5:"FIVE"};class nt{constructor(){o(this,"id",tt(4));o(this,"type");o(this,"metadata",{})}static jsonConstructor(t){return new nt().jsonConstructor(t)}static defaultConstructor(t,e){return new nt().defaultConstructor(t,e)}defaultConstructor(t,e){return this.type=t,this.metadata=e,this}jsonConstructor(t){return this.type=t.type,this.metadata=t.metadata,this}get show(){return!0}getType(t){var e,i;return this.type==="OCEAN"||this.type==="WATER"?`${this.type}_${Jt[(i=(e=this.metadata)==null?void 0:e.model_id)!=null?i:0]}`:`${this.type}_${t.toUpperCase()}`}manifest(t){var i,s;let e=`${this.type}_${t.toUpperCase()}`;switch(this.type){case"WATER":case"OCEAN":return{asset:`${this.type}_${Jt[(s=(i=this.metadata)==null?void 0:i.model_id)!=null?s:0]}`,item:0,type:"obj"};case"LAND":return{asset:this.type,type:"gltf",item:{child:0,name:t==="xin-xi"?"LAND_IMPERIUS":e}};case"MOUNTAIN":return t==="bardur"?{asset:e,item:0,type:"gltf"}:{asset:this.type,item:0,type:"gltf"};case"FOREST":return t==="bardur"?{asset:e,item:0,type:"gltf"}:{asset:this.type,item:0,type:"gltf"};default:return{asset:this.type,item:0,type:"gltf"}}}toJSON(){return{type:this.type,metadata:this.metadata}}}class ri{constructor(t){o(this,"_data");this.city=t}init(){this._data=[Array.from({length:2},()=>Array.from({length:2},()=>M.int(1,5))),Array.from({length:2},(t,e)=>Array.from({length:2},(i,s)=>{const a=()=>M.float(0,1)>.5?null:M.int(1,5);return e===1&&s===1&&this.city.capital?0:a()}))]}getSizeing(){switch(this.city.city_level){case 0:case 1:return{OFFSET:.35,SPACING:.9,SIZE:2};case 2:case 3:case 4:return{OFFSET:.7,SPACING:.8,SIZE:3};default:return{OFFSET:1.1,SPACING:.7,SIZE:4}}}set load(t){this._data=t}toJSON(){return this._data}refactor(){const{SIZE:t}=this.getSizeing();if(this._data[0][0].length!==t)for(let e=0;e<this._data.length;e++)this._data[e]=Array.from({length:t},()=>Array.from({length:t},()=>null))}generateLevel(){this.refactor();const{SIZE:t}=this.getSizeing();this._data.push(Array.from({length:t},()=>Array.from({length:t},(e,i)=>null)));for(let e=0;e<this._data.length;e++)for(let i=0;i<this._data[e].length;i++)for(let s=0;s<this._data[e][i].length;s++){if(e===this._data.length-1&&s===t-1&&i===t-1){const a=r=>this._data[r-1]&&this._data[r-1][i][s]===null?a(r-1):r;this._data[a(e)][i][s]=0;continue}if(this._data[e-1]&&this._data[e-1][i][s]===null){this._data[e][i][s]=null;continue}this._data[e][i][s]=M.float(0,1)>.1?M.int(1,5):null}}*[Symbol.iterator](){if(!this._data)throw new Error(`City level data was not init | ${this.city.id}`);const{SPACING:t,OFFSET:e}=this.getSizeing();let i=0,s=0,a=0,r=0,c=0,h=0;for(;i<this._data.length;){for(;s<this._data[i].length;){for(;a<this._data[i][s].length;)yield{level:h,x:r+e,z:c+e,type:this._data[i][s][a]},a++,r-=t;a=0,r=0,s++,c-=t}s=0,c=0,i++,h+=.7}}}const oi={bardur:["ark","bu","fla","gru","gu","lak","lin","ork","r\xF8","tof","ur"],imperius:["ca","do","ica","ip","lo","lus","ma","mo","mus","nu","pi","re","res","ro","sum","te"]};class ct extends nt{constructor(){super();o(this,"isCity",!0);o(this,"type","CITY");o(this,"capital",!1);o(this,"current_units",0);o(this,"city_wall",!1);o(this,"city_level",1);o(this,"level_data");o(this,"city_name","");this.level_data=new ri(this)}static cityJsonConstructor(t){return new ct().cityJsonConstructor(t)}static cityDefaultConstructor(t){return new ct().cityDefaultConstructor(t)}get uiName(){return`The city of ${this.city_name} lvl ${this.city_level}`}get key(){return`${this.type}_${this.id}`}cityJsonConstructor(t){return this.capital=t.capital,this.current_units=t.current_units,this.city_wall=t.city_wall,this.city_level=t.city_level,this.metadata=t.metadata,this.level_data.load=t.level_data,this.city_name=t.city_name,this}cityDefaultConstructor(t){console.log(t),this.capital=t.capital,this.level_data.init();const e=oi[t.tribe],i=M.int(4,6);for(let s=0;s<i;s++)this.city_name+=e[M.int(0,e.length-1)];return this.city_name=lt(this.city_name),this}toJSON(){return{capital:this.capital,city_level:this.city_level,city_wall:this.city_wall,city_name:this.city_name,current_units:this.current_units,type:"CITY",metadata:this.metadata,level_data:this.level_data.toJSON()}}async levelUpCity(t,e,i,s){const a=e.scene.getObject(this.key);if(!a){console.warn("Render | Failed to regenerate city | Why: city object does not exist.");return}a.clean(),this.city_level++,this.level_data.generateLevel(),await this.render(t,e,i,s)}async render(t,e,i,s){try{const a=e.scene.getObject(this.key);if(!a){console.warn("Render | Failed to render city |",this.id,"| Why: Root object does not exist.");return}for(const r of this.level_data){if(r.type===null)continue;let c=a.getObjectInstance(`CITY_PART_${r.type}`);if(!c){const h=await t.getAsset(`${i.toUpperCase()}_CITY`,r.type,"gltf");c=a.createObjectInstance(`CITY_PART_${r.type}`,h.geometry,h.material)}c.createInstance({id:"",index:0,owner:s,rotation:0,shown:!0,type:"tile",x:r.x,y:r.level,z:r.z})}}catch(a){console.warn(`%cRender City | ${this.id} | Why: ${a.message}`,["color: #eee","background-color: red"])}}}class ht{constructor(){o(this,"id",tt(4));o(this,"type");o(this,"metadata",{replaced_with:null})}static createFromJson(t){return t?new ht().initFromJson(t):null}static createNew(t){return new ht().init(t)}init(t){return t.includes("RUIN")?(this.type=t[t.findIndex(e=>e==="RUIN")],t.length>1&&(this.metadata.replaced_with=t[t.findIndex(e=>e!=="RUIN")])):this.type=t[0],this}initFromJson(t){return this.type=t.type,this.metadata=t.metadata,this}toJSON(){return{type:this.type,metadata:this.metadata}}getType(t){return this.type==="GAME"||this.type==="FRUIT"?`${this.type}_${t.toUpperCase()}`:this.type}manifest(t){return this.type==="GAME"||this.type==="FRUIT"?{asset:`${this.type}_${t.toUpperCase()}`,item:0,type:"gltf"}:{asset:this.type,item:0,type:"gltf"}}}var Gt;(function(n){n[n.TILE=0]="TILE",n[n.UNIT=1]="UNIT"})(Gt||(Gt={}));class ut{constructor(t,e,i){o(this,"selected",0);o(this,"isSelected",!1);o(this,"uuid",tt());o(this,"road",!1);o(this,"top",null);o(this,"base");o(this,"unit",null);o(this,"events",new q);o(this,"position");o(this,"tribe");o(this,"owning_tribe",null);o(this,"override",null);o(this,"deselectionHandle",()=>{this.selected=0,this.isSelected=!1});o(this,"resetHandle",t=>{t.data.uuid!==this.uuid&&(this.override=null,this.deselectionHandle())});o(this,"selectionHandle",t=>{if(t.data.owner===this.uuid){if(this.override){this.events.dispatchEvent(this.override);return}if(!this.isSelected){if(this.events.emit({type:_.INTERACTION,id:A.RESET,data:{uuid:this.uuid}}),this.isSelected=!0,this.unit){this.selected=1,this.selectionEvent("unit"),this.events.emit({type:_.UNIT,id:$.GENERATE,data:{unit:this.unit}});return}this.selected=0,this.selectionEvent("tile"),this.events.emit({type:_.UNIT,id:$.HIDE_SELECTOR,data:{}});return}if(this.selected===1){this.selected=0,this.selectionEvent("tile"),this.events.emit({type:_.UNIT,id:$.HIDE_SELECTOR,data:{}});return}this.deselectionHandle(),this.events.emit({type:_.INTERACTION,id:A.DESELECTION,data:{tile_deselection:!0}})}});this.engine=t,this.assets=e,this.world=i,this.events.on(_.INTERACTION,s=>{switch(s.id){case A.TILE_SELECT:this.selectionHandle(s);break;case A.RESET:this.resetHandle(s);break;case A.DESELECTION:this.deselectionHandle()}}),this.events.on(_.ACTION,s=>{if(s.data.tile===this.uuid)switch(s.id){case U.SPAWN:this.world.unit_controller.createUnit(this.owning_tribe,s.data.type,this.position);break;case U.CREATE:break;case U.DESTORY:this.removeBuilding();break;case U.DISBAND:this.unit&&this.world.unit_controller.destoryUnit(this.unit);break;case U.GATHER:this.removeBuilding();break;case U.HEAL:break;case U.RECOVER:break}})}static createFromJson(t,e,i,s){return new ut(t,e,i).initFromJson(s)}static createNew(t,e,i,s){return new ut(t,e,i).init(s)}get getPreivew(){var e;if(this.unit&&this.selected===1){const i=(e=this.world.units.get(this.unit))==null?void 0:e.model_id;return i?[i]:[]}const t=[this.base.getType(this.tribe)];return this.top&&t.push(this.top.getType(this.tribe)),t}uiText(){const t=()=>{var i;if(this.unit&&this.selected===1){const s=this.world.units.get(this.unit);return s?`${lt(s.tribe)} ${lt(s.type)}`:"Undefined"}return this.top&&["RUIN","VILLAGE"].includes(this.top.type)?lt(this.top.type):((i=this.base)==null?void 0:i.isCity)?this.base.uiName:`${lt(this.base.type)}${this.top?`, ${this.top.type.toLowerCase()}`:""}${this.road?", roads":""} `},e=()=>{var i;return((i=this.base)==null?void 0:i.isCity)?this.world.players.activePlayer===this.owning_tribe?"Choose a unit to produce":"Move a unit here to capture this city!":""};return{title:t(),desc:e()}}terrainBouns(){var t;switch(this.base.type){case"LAND":return 1;case"FOREST":return this.owning_tribe&&this.world.players.playerHasTech(this.owning_tribe,"archery")?1.5:1;case"WATER":case"OCEAN":return this.owning_tribe&&this.world.players.playerHasTech(this.owning_tribe,"aquatism")?1.5:1;case"MOUNTAIN":return this.owning_tribe&&this.world.players.playerHasTech(this.owning_tribe,"meditation")?1.5:1;case"CITY":const e=this.world.units.get(this.unit);return((t=this.base.metadata)==null?void 0:t.cityWall)&&(e==null?void 0:e.tribe)===this.owning_tribe&&(e==null?void 0:e.skills.includes("FORTIFY"))?4:1;default:return 1}}init(t){return this.position={row:t.row,col:t.col},this.tribe=t.tribe,t.base==="CITY"?(this.owning_tribe=this.tribe,this.road=!0,this.base=ct.cityDefaultConstructor(Mt({tribe:this.tribe},t.metadata))):(this.base=nt.defaultConstructor(t.base,t.metadata),t.buldings.length>0&&(this.top=ht.createNew(t.buldings))),this}initFromJson(t){return this.position=t.position,this.tribe=t.tribe,t.base.type==="CITY"?this.base=ct.cityJsonConstructor(t.base):(this.base=nt.jsonConstructor(t.base),this.top=ht.createFromJson(t.top)),this.road=t.road,this.owning_tribe=t.owning_tribe,this}toJSON(){var t,e;return{top:(e=(t=this.top)==null?void 0:t.toJSON())!=null?e:null,base:this.base.toJSON(),tribe:this.tribe,position:this.position,road:this.road,owning_tribe:this.owning_tribe}}setUnit(t=null){return this.unit=t,this}selectionEvent(t){this.events.emit({type:_.INTERACTION,id:A.SELECTION,data:{world:this.position,type:t}})}addBuilding(){}removeBuilding(){if(!!this.top)try{const t=this.top.getType(this.tribe);let e=this.engine.scene.getObject(t);if(!e)throw new Error(`Failed to destory object | ${t}:${this.top.id} | Why: Object type does not exist`);e.removeInstanceById(this.top.id)}catch(t){console.warn(t)}}destory(){try{const t=this.base.getType(this.tribe);let e=this.engine.scene.getObject(t);if(!e)throw new Error(`Failed to destory object | ${t}:${this.base.id} | Why: Object type does not exist`);e.removeInstanceById(this.base.id),this.removeBuilding()}catch(t){console.warn(t)}}async render(){var t,e,i,s,a,r;try{if((t=this.base)==null?void 0:t.isCity){const u=this.base;let f=this.engine.scene.getObject(u.key);if(!f){const p={child:0,name:`LAND_${this.owning_tribe==="xin-xi"?"IMPERIUS":(e=this.owning_tribe)==null?void 0:e.toUpperCase()}`},w=await this.assets.getAsset("LAND",p,"gltf");f=this.engine.scene.createCityInstance(u.key,this.position,this.uuid,w.geometry,w.material),await u.render(this.assets,this.engine,this.owning_tribe,this.uuid)}return}const c=this.base.getType(this.tribe);let h=this.engine.scene.getObject(c);if(!h){const{asset:u,type:f,item:p}=this.base.manifest(this.tribe),w=await this.assets.getAsset(u,p,f);h=this.engine.scene.createObjectInstance(c,w.geometry,w.material),h.renderOrder=V.BASE}if(h.createInstance({index:0,owner:this.uuid,rotation:(s=(i=this.base.metadata)==null?void 0:i.rotation)!=null?s:0,shown:!0,x:this.position.row,z:this.position.col,y:0,id:this.base.id,type:"tile"}),this.top){const u=this.top.getType(this.tribe);let f=this.engine.scene.getObject(u);if(!f){const{asset:p,item:w,type:S}=this.top.manifest(this.tribe),T=await this.assets.getAsset(p,w,S);f=this.engine.scene.createObjectInstance(u,T.geometry,T.material),f.renderOrder=V.TOP}f.createInstance({index:0,owner:this.uuid,rotation:(r=(a=this.top.metadata)==null?void 0:a.rotation)!=null?r:0,shown:!0,x:this.position.row,z:this.position.col,y:0,id:this.top.id,type:"tile"})}}catch(c){console.warn(`Render | Failed to render object | ${this.uuid} | Why: ${c.message}`)}}}const Q=class{constructor(t,e,i){o(this,"uuid",tt(8));o(this,"position");o(this,"tribe");o(this,"type");o(this,"movement",1);o(this,"range",1);o(this,"isVeteran",!1);o(this,"skills",["DASH"]);o(this,"attack",2);o(this,"defence",2);o(this,"health",10);o(this,"hasMoved",!1);o(this,"hasAttacked",!1);o(this,"maxHealth",10);this.engine=t,this.asset=e,this.players=i}static createFromJson(t,e,i,s){return new Q(t,e,i).initFromJson(s)}static createNew(t,e,i,s){return new Q(t,e,i).initDefault(s)}get model_id(){return`${this.type}_${this.tribe.toUpperCase()}`}get model_index(){return Q.UNIT_MODEL_ID[this.tribe]}initDefault(t){this.position=t.position,this.type=t.type,this.tribe=t.tribe;const{range:e,maxHealth:i,movement:s,skills:a,defence:r,attack:c}=Q.UNIT_DATA[this.type];return this.movement=s,this.range=e,this.skills=a,this.attack=c,this.defence=r,this.health=i,this.maxHealth=i,this}initFromJson(t){this.position=t.position,this.type=t.type,this.tribe=t.tribe,this.isVeteran=t.is_veteran,this.health=t.health;const{range:e,movement:i,skills:s,defence:a,attack:r}=Q.UNIT_DATA[this.type];return this.movement=i,this.range=e,this.skills=s,this.defence=a,this.attack=r,this}toJSON(){return{position:this.position,tribe:this.tribe,type:this.type,health:this.health,is_veteran:this.isVeteran}}get vaild_terrian(){return this.players.playerHasTech(this.tribe,"climbing")?["LAND","FOREST","MOUNTAIN"]:["LAND","FOREST"]}heal(t){this.health+=t,this.health>this.maxHealth&&(this.health=this.maxHealth)}setPostion(t,e){const i=this.engine.scene.getObject(this.model_id);!i||(this.position=e,i.editInstance(this.uuid,{x:e.row,z:e.col,owner:t}))}set visible(t){const e=this.engine.scene.getObject(this.model_id);if(!e)throw new Error(`Failed to set visablity on non-existint object for Unit: (${this.tribe}_${this.type} | ${this.uuid}) `);e.editInstance(this.uuid,{shown:t})}reset(){this.hasMoved=!1,this.hasAttacked=!1}destory(){const t=this.engine.scene.getObject(this.model_id);if(!t)throw new Error(`Failed to destory non-existint object for Unit: (${this.tribe}_${this.type} | ${this.uuid}) `);t.removeInstanceById(this.uuid)}canMove(){return!this.hasAttacked&&!this.hasMoved}canAttack(){return!this.hasAttacked&&this.hasMoved&&this.skills.includes("DASH")?!0:!this.hasAttacked&&!this.hasMoved}async setTribe(t){if(this.tribe===t)return;const e=this.engine.scene.getObject(this.model_id);if(!e)throw new Error(`Failed to get object for model with id of ${this.model_id}`);const i=e.getItemById(this.uuid);if(!i)throw new Error(`Failed to get instanced data for unit (${this.uuid})`);this.tribe=t,e.removeInstanceById(this.uuid),await this.render(i.owner)}async render(t){try{if(!this.engine||!this.asset)throw new Error("Unit was not init correctly");let e=this.engine.scene.getObject(this.model_id);if(!e){const i=await this.asset.getAsset(this.type,this.model_index,"gltf");e=this.engine.scene.createObjectInstance(this.model_id,i.geometry,i.material),e.renderOrder=V.UNIT}e.createInstance({index:0,id:this.uuid,owner:t,rotation:0,shown:!0,x:this.position.row,z:this.position.col,y:0,type:"unit"})}catch{console.error("Failed to render Unit type: ",this.model_id," with id of ",this.uuid)}}};let dt=Q;o(dt,"UNIT_MODEL_ID",{imperius:0,bardur:1,"xin-xi":2,oumaji:3,kickoo:4,zebasi:5}),o(dt,"UNIT_DATA",{WARRIOR:{defence:2,attack:2,maxHealth:10,movement:1,range:1,skills:["DASH"]}});function li(n,t){return Math.max(Math.abs(t.row-n.row),Math.abs(t.col-n.col))}class Yt{constructor(t,e,i,s){o(this,"ACCELERATOR",4.5);o(this,"events",new q);o(this,"mesh_movement");o(this,"mesh_attack");o(this,"eventHide",()=>{this.hideMovement(),this.hideAttack()});this.engine=t,this.assets=e,this.world=i,this.player=s,this.events.onId({name:_.INTERACTION,id:A.RESET},this.eventHide),this.events.on(_.UNIT,a=>{switch(a.id){case $.ATTACK:return this.eventAttack(a);case $.MOVE:return this.eventMove(a);case $.GENERATE:return this.eventGenerate(a);case $.HIDE_SELECTOR:return this.eventHide()}})}eventAttack(t){const e=this.world.units.get(t.data.attacker),i=this.world.units.get(t.data.defender);if(!e||!i)return;const s=this.world.level.get(i.position.row,i.position.col);if(!s)return;const a=e.attack*(e.health/e.maxHealth),r=i.defence*(i.health/i.maxHealth)*s.terrainBouns(),c=a+r,h=Math.round(a/c*e.attack*this.ACCELERATOR),u=Math.round(r/c*i.defence*this.ACCELERATOR),f=i.health-u;if(f<=0){console.log("Kill unit");const p=i.position;this.destoryUnit(i.uuid),this.moveUnit(e.uuid,p)}else i.health=f,e.health-=h;e.hasAttacked=!0,this.events.emit({type:_.INTERACTION,id:A.RESET,data:{uuid:null}}),this.events.emit({type:_.INTERACTION,id:A.DESELECTION,data:{unit_deselection:!0}})}eventMove(t){this.moveUnit(t.data.unit,t.data.to),this.events.emit({type:_.INTERACTION,id:A.RESET,data:{uuid:null}}),this.events.emit({type:_.INTERACTION,id:A.DESELECTION,data:{unit_deselection:!0}})}eventGenerate(t){const e=this.world.units.get(t.data.unit);!e||e.tribe===this.player.activePlayer&&(this.generateMovementArea(t.data.unit),this.generateAttackArea(e.position,e.range,e.uuid))}async init(){try{const t=this.assets.getVarient("SELECTOR"),e=t.scene.children[0].clone();t.functions.copyVariantMaterials(e,t.scene.children[0]),await t.functions.selectVariant(e,"UnitSelector");let i=e.material.clone();i.color=new Pt("blue");let s=e.material.clone();s.color=new Pt("red"),this.mesh_movement=new bt("SELECTOR_MOVEMENT",e.geometry,i,[]),this.mesh_movement.renderOrder=V.SELECTOR,this.mesh_attack=new bt("SELECTOR_ATTACK",e.geometry,s,[]),this.mesh_attack.renderOrder=V.SELECTOR,this.engine.scene.add(this.mesh_movement,this.mesh_attack)}catch(t){console.error(t)}}destoryUnit(t){const e=this.world.units.get(t);!e||(this.world.level.get(e.position.row,e.position.col).setUnit(),e.destory(),this.world.units.delete(t))}async createUnit(t,e,i){const s=dt.createNew(this.engine,this.assets,this.world.players,{type:e,tribe:t,position:i});this.world.units.set(s.uuid,s);const a=this.world.level.get(i.row,i.col).setUnit(s.uuid);return await s.render(a.uuid),s}moveUnit(t,e){const i=this.world.units.get(t);if(!i)return;const s=this.world.level.get(e.row,e.col);s.setUnit(i.uuid),this.world.level.get(i.position.row,i.position.col).setUnit(null),i.setPostion(s.uuid,e),i.hasMoved=!0}healUnit(t){const e=this.world.units.get(t);if(!e||!(e.health>e.maxHealth))return;let i=2;this.world.level.get(e.position.row,e.position.col).owning_tribe===e.tribe&&(i=4),e.heal(i)}generateMovementArea(t){const e=this.world.units.get(t);if(!e||!e.canMove())return;const i=e.position,s=this.world.level.get(e.position.row,e.position.col).road;this.hideMovement(),this.mesh_movement.removeAll();for(let a=0;a<=this.world.level.size;a++)for(let r=0;r<=this.world.level.size;r++){const c=this.world.level.isValid(a,r);if(!c)continue;let h=1;c.road&&s&&(c.owning_tribe===null||c.owning_tribe===e.tribe)&&(h=.5);const u=li(i,{row:a,col:r})*h;!(u<=1)||u===0||c.unit||!e.vaild_terrian.includes(c.base.type)||(this.mesh_movement.createInstance({index:0,id:tt(10),owner:c.uuid,rotation:0,shown:!0,type:"tile",x:a,z:r,y:0}),this.world.level.get(a,r).override={type:_.UNIT,id:$.MOVE,data:{to:{row:a,col:r},unit:t}})}this.mesh_movement.visible=!0}generateAttackArea(t,e,i){const s=this.world.units.get(i);if(!(!s||!s.canAttack())){this.hideAttack(),this.mesh_attack.removeAll();for(let a=-e;a<=e;a++)for(let r=-e;r<=e;r++){let c=t.row+a,h=t.col+r;const u=this.world.level.isValid(c,h);if(!u||a===0&&r===0||!u.unit)continue;const f=this.world.units.get(u.unit);!f||f.tribe!==s.tribe&&(this.mesh_attack.createInstance({index:0,id:tt(10),owner:u.uuid,rotation:0,shown:!0,type:"tile",x:c,z:h,y:0}),this.world.level.get(c,h).override={type:_.UNIT,id:$.ATTACK,data:{attacker:s.uuid,defender:f.uuid}})}this.mesh_attack.visible=!0}}hideMovement(){this.mesh_movement.visible=!1}hideAttack(){this.mesh_attack.visible=!1}}class qt{constructor(t){o(this,"events",new q);o(this,"mesh");o(this,"style","TileSelector");this.asset=t,this.mesh=t.scene.children[0].clone(!0),t.functions.copyVariantMaterials(this.mesh,t.scene.children[0]),this.mesh.visible=!1,this.mesh.name="Selector",this.mesh.renderOrder=V.SELECTOR,this.events.on(_.INTERACTION,e=>{switch(e.id){case A.DESELECTION:{this.hide(),this.events.emit({type:_.UNIT,id:$.HIDE_SELECTOR,data:{}});break}case A.SELECTION:{if(e.data.type==="unit"?this.setStyle("UnitSelector"):this.setStyle("TileSelector"),this.setVisible(),this.mesh.position.x===e.data.world.row*4&&this.mesh.position.z===e.data.world.col*4)return;this.mesh.position.set(e.data.world.row*4,0,e.data.world.col*4);break}case A.RESET:{this.setVisible();break}}})}setVisible(){this.mesh.visible||(this.mesh.visible=!0)}hide(){this.mesh.visible&&(this.mesh.visible=!1)}async setStyle(t){t!==this.style&&(this.style=t,await this.asset.functions.selectVariant(this.mesh,t))}async render(t){t.scene.add(this.mesh)}}class ci{constructor(t,e,i){o(this,"level");o(this,"units",new Map);o(this,"selector");o(this,"unit_controller");this.engine=t,this.assets=e,this.players=i,this.createWorld(["imperius","bardur"],11)}async createWorld(t,e){try{const a=this.assets.getVarient("SELECTOR");this.selector=new qt(a),this.selector.render(this.engine),this.unit_controller=new Yt(this.engine,this.assets,this,this.players),await this.unit_controller.init()}catch(a){console.error(a)}const i=si.gen(t,e),s=new Lt(e);this.engine.scene.activeLevelReady();for(const a of i)s.set(a.row,a.col,ut.createNew(this.engine,this.assets,this,a)),await s.get(a.row,a.col).render();return this.level=s,s}async loadWorld(t){try{const i=this.assets.getVarient("SELECTOR");this.selector=new qt(i),this.selector.render(this.engine),this.unit_controller=new Yt(this.engine,this.assets,this,this.players),await this.unit_controller.init()}catch(i){console.error(i)}const e=new Lt(t.size);this.engine.scene.activeLevelReady();for(const i of t.leveldata.overworld)e.set(i.position.row,i.position.col,ut.createFromJson(this.engine,this.assets,this,i)),await e.get(i.position.row,i.position.col).render();for(const i of t.units){const s=dt.createFromJson(this.engine,this.assets,this.players,i);this.units.set(s.uuid,s);const a=e.get(i.position.row,i.position.col).setUnit(s.uuid);await s.render(a.uuid)}return this.level=e,e}levelToJson(){let t=[];for(const e of this.level)t.push(e.toJSON());return t}unitsToJson(){let t=[];return this.units.forEach(e=>{t.push(e.toJSON())}),t}async saveWorld(){return{size:this.level.size,leveldata:{overworld:this.levelToJson()},units:this.unitsToJson()}}}class hi{constructor(t,e){o(this,"tech",{climbing:!1,fishing:!1,hunting:!1,organization:!1,riding:!1,archery:!1,farming:!1,forestry:!1,free_spirit:!1,meditation:!1,mining:!1,roads:!1,sailing:!1,shields:!1,whaling:!1,aquatism:!1,chivalry:!1,construction:!1,mathematics:!1,navigation:!1,smithery:!1,spiritualism:!1,trade:!1,philosophy:!1});switch(this.tribe=t,this.uuid=e,t){case"bardur":this.tech.hunting=!0;break;case"imperius":this.tech.organization=!0;break;case"kickoo":this.tech.fishing=!0;break;case"oumaji":this.tech.riding=!0;break;case"xin-xi":this.tech.climbing=!0;break;case"zebasi":this.tech.farming=!0;break}}toJSON(){return{tribe:this.tribe,uuid:this.uuid,tech:this.tech}}}class Tt{constructor(){o(this,"players",new Map);o(this,"_active_player","imperius")}static loadFromJson(){return new Tt().jsonConstructor()}static init(t){return new Tt().defaultConstructor(t)}set activePlayer(t){this._active_player=t}get activePlayer(){return this._active_player}jsonConstructor(){return this}defaultConstructor(t){for(const e of t)this.players.set(e,new hi(e,null));return this}activePlayerHas(t){return this.playerHasTech(this.activePlayer,t)}playerHasTech(t,e){var s;const i=this.players.get(t);return i&&(s=i.tech[e])!=null?s:!1}toJson(){let t=[];return this.players.forEach(e=>{t.push(e.toJSON())}),{players:t,active_player:this._active_player}}}const pt=class{constructor(){o(this,"events",new q);o(this,"assets");o(this,"engine");o(this,"world");o(this,"players");if(pt.INSTANCE)return pt.INSTANCE;pt.INSTANCE=this,window.POLYTOPIA_GAME=this}async init(){return console.info("Init | Starting loading of Assets"),this.assets=new Rt,await this.assets.init(),this.events.on(_.SOUND,t=>{try{this.assets.playSound(t.data.sound)}catch(e){console.error(e)}}),this}async initEngine(t){this.engine=new ti(t),this.engine.init(),console.info("Init Engine | Starting threejs env",t),this.players=Tt.init(["bardur","imperius"]),this.world=new ci(this.engine,this.assets,this.players)}async destory(){console.info("Starting Destory Game"),this.engine.destory()}};let at=pt;o(at,"INSTANCE",null);const ui={FRUIT_BARDUR:{frame:{x:0,y:0,w:214,h:250}},FRUIT_IMPERIUS:{frame:{x:214,y:0,w:214,h:250}},LAND_IMPERIUS:{frame:{x:428,y:0,w:214,h:250}},OCEAN:{frame:{x:642,y:0,w:214,h:250}},VILLAGE:{frame:{x:856,y:0,w:214,h:250}},WARRIOR_IMPERIUS:{frame:{x:1070,y:0,w:214,h:250}},WATER:{frame:{x:1284,y:0,w:214,h:250}}};var di={frames:ui},Kt="/demo8/assets/tiles.be8d52ae.webp";function Zt(n,t,e){const i=n.slice();return i[16]=t[e],i}function Xt(n){let t,e,i,s,a,r,c,h,u,f,p,w,S,T,j,k,Z,B,v,N;k=new He({props:{class:"rounded-circle bg-light",$$slots:{default:[fi]},$$scope:{ctx:n}}}),k.$on("click",n[5]);let y=n[3].length>0&&Qt(n);return{c(){t=D("div"),e=D("header"),i=D("div"),s=D("div"),a=D("canvas"),r=ot(),c=D("div"),h=D("h6"),u=D("strong"),f=At(n[1]),p=ot(),w=D("span"),S=At(n[2]),T=ot(),j=D("div"),yt(k.$$.fragment),Z=ot(),y&&y.c(),C(a,"width","60"),C(a,"height","60"),C(a,"class","svelte-1jk1l4v"),C(s,"class","preview-img svelte-1jk1l4v"),C(h,"class","svelte-1jk1l4v"),C(w,"class","svelte-1jk1l4v"),C(c,"class","title-desc svelte-1jk1l4v"),C(i,"class","preview svelte-1jk1l4v"),C(e,"class","svelte-1jk1l4v"),C(t,"id","tile-actions"),C(t,"class","bg-dark svelte-1jk1l4v")},m(I,L){et(I,t,L),R(t,e),R(e,i),R(i,s),R(s,a),n[7](a),R(i,r),R(i,c),R(c,h),R(h,u),R(u,f),R(c,p),R(c,w),R(w,S),R(e,T),R(e,j),wt(k,j,null),R(t,Z),y&&y.m(t,null),N=!0},p(I,L){(!N||L&2)&&Ot(f,I[1]),(!N||L&4)&&Ot(S,I[2]);const J={};L&524288&&(J.$$scope={dirty:L,ctx:I}),k.$set(J),I[3].length>0?y?y.p(I,L):(y=Qt(I),y.c(),y.m(t,null)):y&&(y.d(1),y=null)},i(I){N||(X(k.$$.fragment,I),Me(()=>{v&&v.end(1),B=De(t,je,{y:200,duration:200}),B.start()}),N=!0)},o(I){st(k.$$.fragment,I),B&&B.invalidate(),v=Ue(t,Ve,{}),N=!1},d(I){I&&it(t),n[7](null),vt(k),y&&y.d(),I&&v&&v.end()}}}function fi(n){let t,e;return t=new We({props:{id:"action",class:"text-dark",name:"chevron-compact-down"}}),{c(){yt(t.$$.fragment)},m(i,s){wt(t,i,s),e=!0},p:Ct,i(i){e||(X(t.$$.fragment,i),e=!0)},o(i){st(t.$$.fragment,i),e=!1},d(i){vt(t,i)}}}function Qt(n){let t,e=n[3],i=[];for(let s=0;s<e.length;s+=1)i[s]=zt(Zt(n,e,s));return{c(){t=D("main");for(let s=0;s<i.length;s+=1)i[s].c();C(t,"class","border-top border-light svelte-1jk1l4v")},m(s,a){et(s,t,a);for(let r=0;r<i.length;r+=1)i[r].m(t,null)},p(s,a){if(a&72){e=s[3];let r;for(r=0;r<e.length;r+=1){const c=Zt(s,e,r);i[r]?i[r].p(c,a):(i[r]=zt(c),i[r].c(),i[r].m(t,null))}for(;r<i.length;r+=1)i[r].d(1);i.length=e.length}},d(s){s&&it(t),xe(i,s)}}}function zt(n){let t,e=n[16].id+"",i,s,a;function r(){return n[8](n[16])}return{c(){t=D("div"),i=At(e),C(t,"class","rounded-circle border border-3 bg-primary tile-action svelte-1jk1l4v")},m(c,h){et(c,t,h),R(t,i),s||(a=ke(t,"click",r),s=!0)},p(c,h){n=c,h&8&&e!==(e=n[16].id+"")&&Ot(i,e)},d(c){c&&it(t),s=!1,a()}}}function mi(n){let t,e,i=n[0]&&Xt(n);return{c(){i&&i.c(),t=Pe()},m(s,a){i&&i.m(s,a),et(s,t,a),e=!0},p(s,[a]){s[0]?i?(i.p(s,a),a&1&&X(i,1)):(i=Xt(s),i.c(),X(i,1),i.m(t.parentNode,t)):i&&($e(),st(i,1,1,()=>{i=null}),Fe())},i(s){e||(X(i),e=!0)},o(s){st(i),e=!1},d(s){i&&i.d(s),s&&it(t)}}}function pi(n,t,e){let i=!1,s="TILE NAME",a="",r=[],c=[],h;const u=new Image,f=new at,p=(v,N)=>{if(!N||v.length!==N.length)return!1;let y=0;for(;y<v.length;){if(v[y]!==N[y])return!1;y++}return!0},w=async v=>{const N=f.world.level.get(v.data.world.row,v.data.world.col).getPreivew;if(p(c,N))return;const{title:y,desc:I}=f.world.level.get(v.data.world.row,v.data.world.col).uiText();if(e(1,s=y),e(2,a=I),u.src!==Kt&&await new Promise((J,z)=>{u.onload=()=>J(),u.src=Kt}),!h)return;const L=h.getContext("2d");L==null||L.clearRect(0,0,h.width,h.height);for(const J of N){const z=di.frames[J];if(!z)continue;const{frame:G}=z;L==null||L.drawImage(u,G.x,G.y,G.w,G.h,0,0,G.w/4,G.h/4)}c=N},S=async v=>{var N;const y=f.world.level.get(v.data.world.row,v.data.world.col);if(y.unit!==null){const I=f.world.units.get(y.unit);if(!I||f.world.players.activePlayer!==I.tribe)return;I.health<I.maxHealth&&r.push({id:U.RECOVER,data:{unit:y.unit,tile:y.uuid}}),f.world.players.activePlayerHas("free_spirit")&&r.push({id:U.DISBAND,data:{unit:y.unit,tile:y.uuid}}),I.type==="MIND_BENDER"&&r.push({id:U.HEAL,data:{unit:y.unit,tile:y.uuid}});return}if((N=y.base)===null||N===void 0?void 0:N.isCity){if(y.owning_tribe!==f.world.players.activePlayer)return;r.push({id:U.SPAWN,data:{tile:y.uuid,type:"WARRIOR"}});return}},T=v=>{switch(v.id){case A.SELECTION:e(0,i=!0),w(v),S(v);break;case A.DESELECTION:default:e(0,i=!1),e(3,r=[]);break}},j=()=>{e(0,i=!1),f.events.emit({type:_.INTERACTION,id:A.DESELECTION,data:{}})},k=v=>{f.events.emit(Object.assign({type:_.ACTION},v))};f.events.on(_.INTERACTION,T);function Z(v){$t[v?"unshift":"push"](()=>{h=v,e(4,h)})}return[i,s,a,r,h,j,k,Z,v=>k(v)]}class gi extends It{constructor(t){super();St(this,t,pi,mi,Nt,{})}}function yi(n){let t,e,i,s,a;return s=new gi({}),{c(){t=D("div"),e=D("canvas"),i=ot(),yt(s.$$.fragment),C(e,"id","polytopia"),C(e,"class","svelte-rjqmzm"),C(t,"id","game-view"),C(t,"class","svelte-rjqmzm")},m(r,c){et(r,t,c),R(t,e),n[1](e),R(t,i),wt(s,t,null),a=!0},p:Ct,i(r){a||(X(s.$$.fragment,r),a=!0)},o(r){st(s.$$.fragment,r),a=!1},d(r){r&&it(t),n[1](null),vt(s)}}}function wi(n,t,e){let i;Ft(()=>{var a;(a=at.INSTANCE)===null||a===void 0||a.init().then(r=>{r.initEngine(i)})}),Be(()=>{var a;(a=at.INSTANCE)===null||a===void 0||a.destory()});function s(a){$t[a?"unshift":"push"](()=>{i=a,e(0,i)})}return[i,s]}class vi extends It{constructor(t){super();St(this,t,wi,yi,Nt,{})}}function Ei(n){let t,e,i;return e=new vi({}),{c(){t=D("div"),yt(e.$$.fragment),C(t,"class","App svelte-1vn82yk")},m(s,a){et(s,t,a),wt(e,t,null),i=!0},p:Ct,i(s){i||(X(e.$$.fragment,s),i=!0)},o(s){st(e.$$.fragment,s),i=!1},d(s){s&&it(t),vt(e)}}}function bi(n){let t=0;return Ft(()=>{const e=setInterval(()=>t++,1e3);return()=>{clearInterval(e)}}),[]}class Ti extends It{constructor(t){super();St(this,t,bi,Ei,Nt,{})}}new at;new Ti({target:document.body});
