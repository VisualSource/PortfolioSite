var J=Object.defineProperty;var Q=(i,e,t)=>e in i?J(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>(Q(i,typeof e!="symbol"?e+"":e,t),t);import{M as S,a as C,D as F,G as ee,C as p,A as te,b as se,c as ie,S as ne,P as re,W as oe,R as ae,d as I,e as le,s as ce,f as ue,g as de,E as he,h as j,i as me,F as fe,j as O,B as P,H as ge,k as pe,l as ye,m as be,V as N,n as Ee,o as k,p as we,q as ve,r as Ie,t as Te,u as xe}from"./vendor.208b5754.js";const _e=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}};_e();class De{constructor(e,t,s){a(this,"element");this.element=e,Object.keys(s.registeredGestures).forEach(n=>{this[n]=(r,o)=>(s.addBinding(this.element,n,r,o,t),this)})}}const q=360,Le=180;function L(i){switch(i){case"mousedown":case"touchstart":case"pointerdown":return"start";case"mousemove":case"touchmove":case"pointermove":return"move";case"mouseup":case"touchend":case"pointerup":return"end";default:return null}}function Se(i,e,t,s,n){return Math.abs(e-s)<=n&&Math.abs(i-t)<=n}function U(i,e,t,s){let n=Math.sqrt((e-i)*(e-i)+(s-t)*(s-t));return Math.round(n*100)/100}function H(i,e,t,s){let n=Math.atan2(s-e,t-i)*(Le/Math.PI);return q-(n<0?q+n:n)}function Pe(i,e,t,s,n,r){return U(i,s,e,n)/(r-t)}function Ae(i){return typeof i=="number"&&i%1==0}function M(i,e,t){const s=t.getBoundingClientRect();return i>s.left&&i<s.left+s.width&&e>s.top&&e<s.top+s.height}function Be(i){if(i.path)return i.path;{let e=[],t=i.target;for(;t!=document;)e.push(t),t=t.parentNode;return e}}function W(i,e){let t=i.length;return i.forEach((s,n)=>{s===e&&(t=n)}),t}function Ce(i){i.style["-ms-content-zooming"]="none",i.style["touch-action"]="none"}function Fe(i){i.style["-ms-content-zooming"]="",i.style["touch-action"]=""}class A{constructor(){a(this,"type");a(this,"id",null)}setType(e){this.type=e}getType(){return this.type}setId(e){this.id=e}getId(){return this.id!==null?this.id:this.type}update(e){for(let t in e)this[t]&&(this[t]=e[t])}move(e,t,s){return null}isValid(e,t,s){let n=!0;return e.length>1&&e.forEach(r=>{M(r.initial.x,r.initial.y,s)||(n=!1)}),n}}function Oe(i,e,t){e.events=t;const s=new CustomEvent(i.gesture.getId(),{detail:e,bubbles:!0,cancelable:!0});Me(i.element,s,i)}function Me(i,e,t){i.dispatchEvent(e),t.bindOnce&&T.unbind(t.element,t.gesture.getType())}function Ge(i,e,t){const s=L(e.type),n=[];return i.forEach(r=>{let o=r.gesture[s](t.inputs,t,r.element);if(o){const l=[];t.inputs.forEach(c=>{l.push(c.current)}),n.push({binding:r,data:o,events:l})}}),n}function Re(i,e){const t=e.state;if(t.inputs.length===0&&L(i.type)!=="start")return;if(typeof i.buttons!="undefined"&&L(i.type)!=="end"&&i.buttons===0){t.resetInputs();return}if(!t.updateInputs(i,e.element))return;const s=t.retrieveBindingsByInitialPos();if(s.length>0){e.preventDefault?(Ce(e.element),i.preventDefault?i.preventDefault():i.returnValue=!1):Fe(e.element);const r={};Ge(s,i,t).forEach(l=>{const c=l.binding.gesture.id;if(r[c]){const f=Be(i);W(f,l.binding.element)<W(f,r[c].binding.element)&&(r[c]=l)}else r[c]=l}),Object.keys(r).forEach(l=>{const c=r[l];Oe(c.binding,c.data,c.events)})}let n=0;t.inputs.forEach(r=>{r.getCurrentEventType()==="end"&&n++}),n===t.inputs.length&&t.resetInputs()}const je=1,Ne=100,ke=.2,qe=100,Ue=10;class He extends A{constructor(e){super();a(this,"numInputs");a(this,"maxRestTime");a(this,"escapeVelocity");a(this,"timeDistortion");a(this,"maxProgressStack");a(this,"initial");this.type="swipe",this.numInputs=e&&e.numInputs?e.numInputs:je,this.maxRestTime=e&&e.maxRestTime?e.maxRestTime:Ne,this.escapeVelocity=e&&e.escapeVelocity?e.escapeVelocity:ke,this.timeDistortion=e&&e.timeDistortion?e.timeDistortion:qe,this.maxProgressStack=e&&e.maxProgressStack?e.maxProgressStack:Ue}start(e,t,s){return this.initial=e[0].initial,null}move(e,t,s){if(this.numInputs===e.length)for(let n=0;n<e.length;n++){let r=e[n].getGestureProgress(this.getId());r.moves||(r.moves=[]),r.moves.push({time:new Date().getTime(),x:e[n].current.x,y:e[n].current.y}),r.length>this.maxProgressStack&&r.moves.shift()}return null}end(e){if(this.numInputs===e.length){let s={data:[]},n;for(var t=0;t<e.length;t++){if(e[t].current.type!=="end")return;let r=e[t].getGestureProgress(this.getId());if(r.moves&&r.moves.length>2){let o=r.moves.pop();if(new Date().getTime()-o.time>this.maxRestTime)return null;let l,c=r.moves.length-1;for(;c!==-1;){if(r.moves[c].time!==o.time){l=r.moves[c];break}c--}l||(l=r.moves.pop(),l.time+=this.timeDistortion),n=Pe(l.x,l.y,l.time,o.x,o.y,o.time),s.data[t]={lastMove:this.initial,velocity:n,distance:U(l.x,o.x,l.y,o.y),duration:o.time-l.time,currentDirection:H(l.x,l.y,o.x,o.y)}}}for(let r=0;r<s.data.length;r++)if(n<this.escapeVelocity)return null;if(s.data.length>0)return s}return null}}const We=0,Xe=300,Ye=1,$e=10;class X extends A{constructor(e){super();a(this,"minDelay");a(this,"maxDelay");a(this,"numInputs");a(this,"tolerance");this.type="tap",this.minDelay=(e==null?void 0:e.minDelay)?e.minDelay:We,this.maxDelay=(e==null?void 0:e.maxDelay)?e.maxDelay:Xe,this.numInputs=(e==null?void 0:e.numInputs)?e.numInputs:Ye,this.tolerance=(e==null?void 0:e.tolerance)?e.tolerance:$e}start(e){return e.length===this.numInputs&&e.forEach(t=>{let s=t.getGestureProgress(this.type);s.start=new Date().getTime()}),null}move(e,t,s){for(let n=0;n<e.length;n++)if(e[n].getCurrentEventType()==="move"){let r=e[n].current,o=e[n].previous;if(!Se(r.x,r.y,o.x,o.y,this.tolerance)){let l=this.type;return e.forEach(function(c){c.resetProgress(l)}),null}}return null}end(e){if(e.length!==this.numInputs)return null;let t=Number.MAX_VALUE;for(let n=0;n<e.length;n++){if(e[n].getCurrentEventType()!=="end")return null;let r=e[n].getGestureProgress(this.type);if(!r.start)return null;r.start<t&&(t=r.start)}let s=new Date().getTime()-t;if(this.minDelay<=s&&this.maxDelay>=s)return{interval:s};{let n=this.type;return e.forEach(function(r){r.resetProgress(n)}),null}}}class ze{constructor(e,t,s,n=!1,r=!1){this.element=e,this.gesture=t,this.handler=s,this.capture=n,this.bindOnce=r}}const Y=0;class ${constructor(e,t){a(this,"originalEvent");a(this,"type");a(this,"x");a(this,"y");a(this,"clientX");a(this,"clientY");a(this,"pageX");a(this,"pageY");a(this,"screenX");a(this,"screenY");this.originalEvent=e,this.type=L(e.type),this.x=Y,this.y=Y;let s;if(e.touches&&e.changedTouches){for(let n=0;n<e.changedTouches.length;n++)if(e.changedTouches[n].identifier===t){s=e.changedTouches[n];break}}else s=e;this.x=this.clientX=s.clientX,this.y=this.clientY=s.clientY,this.pageX=s.pageX,this.pageY=s.pageY,this.screenX=s.screenX,this.screenY=s.screenY}}class Ve{constructor(e,t=0){a(this,"initial");a(this,"current");a(this,"previous");a(this,"progress",{});this.identifier=t;let s=new $(e,t);this.initial=s,this.current=s,this.previous=s}update(e,t){this.previous=this.current,this.current=new $(e,t)}getGestureProgress(e){return this.progress[e]||(this.progress[e]={}),this.progress[e]}getCurrentEventType(){return this.current.type}resetProgress(e){this.progress[e]={}}}class Ze extends X{constructor(){super({numInputs:2})}}const z=0;class Ke{constructor(e){a(this,"inputs",[]);a(this,"bindings",[]);a(this,"numGestures",0);a(this,"registeredGestures",{});this.regionId=e,this.registerGesture(new He,"swipe"),this.registerGesture(new X,"tap"),this.registerGesture(new Ze,"double")}addBinding(e,t,s,n,r){let o;if(e&&typeof e.tagName=="undefined")throw new Error("Parameter element is an invalid object.");if(typeof s!="function")throw new Error("Parameter handler is invalid.");if(typeof t=="string"&&Object.keys(this.registeredGestures).indexOf(t)===-1)throw new Error("Parameter "+t+" is not a registered gesture");if(typeof t=="object"&&!(t instanceof A))throw new Error("Parameter for the gesture is not of a Gesture type");typeof t=="string"?o=this.registeredGestures[t]:(o=t,o.id===""&&this.assignGestureId(o)),this.bindings.push(new ze(e,o,s,n,r)),e.addEventListener(o.getId(),s,n)}retrieveBindingsByElement(e){let t=[];return this.bindings.map(s=>{s.element===e&&t.push(s)}),t}retrieveBindingsByInitialPos(){let e=[];return this.bindings.forEach(t=>{this.inputs.filter(n=>M(n.initial.x,n.initial.y,t.element)).length>0&&e.push(t)}),e}updateInputs(e,t){let s=z;switch(e.touches?"TouchEvent":e.pointerType?"PointerEvent":"MouseEvent"){case"TouchEvent":for(let o in e.changedTouches)e.changedTouches.hasOwnProperty(o)&&Ae(parseInt(o))&&(s=e.changedTouches[o].identifier,r(e,this,s,t));break;case"PointerEvent":s=e.pointerId,r(e,this,s,t);break;case"MouseEvent":default:r(e,this,z,t);break}return!0;function r(o,l,c,f){let g=L(o.type),m=Je(l.inputs,c);if(g==="start"&&m){l.resetInputs();return}if(g!=="start"&&m&&!M(m.current.x,m.current.y,f)){l.resetInputs();return}if(g!=="start"&&!m){l.resetInputs();return}g==="start"?l.inputs.push(new Ve(o,c)):m.update(o,c)}}resetInputs(){this.inputs=[]}numActiveInputs(){return this.inputs.filter(t=>t.current.type!=="end").length}registerGesture(e,t){this.assignGestureId(e),this.registeredGestures[t]=e}assignGestureId(e){e.setId(this.regionId+"-"+this.numGestures++)}}function Je(i,e){for(let t=0;t<i.length;t++)if(i[t].identifier===e)return i[t];return null}class Qe{constructor(e,t,s,n){a(this,"state");this.element=e,this.capture=t,this.preventDefault=s,this.id=n,this.id=n,this.element=e,this.capture=typeof t!="undefined"?t:!1,this.preventDefault=typeof s!="undefined"?s:!0,this.state=new Ke(n.toString());let r=[];window.PointerEvent&&!window.TouchEvent?r=["pointerdown","pointermove","pointerup"]:r=["mousedown","mousemove","mouseup","touchstart","touchmove","touchend"],r.map(o=>{e.addEventListener(o,l=>{Re(l,this)},this.capture)})}bind(e,t,s,n,r=!1){if(!e||e&&!e.tagName)throw"Bind must contain an element";if(r=typeof r!="undefined"?r:!1,t)this.state.addBinding(e,t,s,n,r);else return new De(e,r,this.state)}bindOnce(e,t,s,n){this.bind(e,t,s,n,!0)}unbind(e,t){let s=this.state.retrieveBindingsByElement(e),n=[];return s.forEach(r=>{t?typeof t=="string"&&this.state.registeredGestures[t]&&this.state.registeredGestures[t].id===r.gesture.id&&(e.removeEventListener(r.gesture.getId(),r.handler,r.capture),n.push(r)):(e.removeEventListener(r.gesture.getId(),r.handler,r.capture),n.push(r))}),n}register(e,t){if(typeof e!="string")throw new Error("Parameter key is an invalid string");if(!(t instanceof A))throw new Error("Parameter gesture is an invalid Gesture object");t.setType(e),this.state.registerGesture(t,e)}unregister(e){this.state.bindings.forEach(s=>{s.gesture.getType()===e&&s.element.removeEventListener(s.gesture.getId(),s.handler,s.capture)});let t=this.state.registeredGestures[e];return delete this.state.registeredGestures[e],t}}let T={_regions:[],Region:function(i,e,t){let s=T._regions.length,n=new Qe(i,e,t,s);return T._regions.push(n),n}};var d;(function(i){i[i.HIDDEN=0]="HIDDEN",i[i.DEFAULT=1]="DEFAULT",i[i.LEFT=2]="LEFT",i[i.RIGHT=3]="RIGHT",i[i.UP=4]="UP",i[i.DOWN=5]="DOWN"})(d||(d={}));var b;(function(i){i[i.BASE=0]="BASE",i[i.TILES=1]="TILES",i[i.BLOOM=2]="BLOOM"})(b||(b={}));const h=(i,e)=>{const t=document.getElementById(e);if(!t){console.error("Failed to find element: ",e);return}t.style.display=i},v=i=>document.dispatchEvent(new CustomEvent("loading",{detail:{id:i}})),x=i=>new Promise((e,t)=>setTimeout(e,i)),y=(i,e)=>document.dispatchEvent(new CustomEvent("location",{detail:{location:i,song_id:e}}));class G extends S{constructor(e,t,s){super(s.tile.scene.children[0].geometry.clone(),new C({color:"black",reflectivity:1,envMap:null}));this.name=e,this.position.setX(t),this.layers.set(b.TILES),this.geometry.center(),this.geometry.translate(0,-.5,0);let n=s.normal.scene.children[0].clone(!0);n.position.setZ(.4),n.position.setY(-.7),n.visible=!1,n.name="Line",n.layers.set(b.BLOOM);let r=s.arrow.scene.children[0].clone();r.position.setZ(.2),r.visible=!1,r.position.setY(-.5),r.name="Arrow",r.layers.set(b.BLOOM),this.add(n,r)}setType(e){switch(this.userData.type=e,this.children.forEach(t=>t.visible=!1),e){case d.DEFAULT:const t=this.getObjectByName("Line");t&&(t.visible=!0);break;case d.LEFT:this.children[1].visible=!0,this.children[1].rotation.z=180*F;break;case d.RIGHT:{this.children[1].visible=!0,this.children[1].rotation.z=0;break}case d.UP:{this.children[1].visible=!0,this.children[1].rotation.z=90*F;break}case d.DOWN:{this.children[1].visible=!0,this.children[1].rotation.z=270*F;break}}}}class et extends ee{constructor(e,t,s){super();this.assets=s,this.name="Row",this.position.setY(t),this.userData={id:e},this.init()}allChildrenHidden(){return!this.children[0].visible&&!this.children[1].visible&&!this.children[2].visible}init(){let e=new G("Left",-1.1,this.assets);e.setType(d.DEFAULT);let t=new G("Middle",0,this.assets);t.setType(d.DEFAULT);let s=new G("Right",1.1,this.assets);s.setType(d.DEFAULT),this.add(e,t,s)}setTileState(e,t){this.children[e].visible=Boolean(t),this.children[e].material.color=new p("black"),this.children[e].setType(t)}}var B;(function(i){i[i.CONTINUE=0]="CONTINUE",i[i.FAIL=1]="FAIL",i[i.DONE=2]="DONE"})(B||(B={}));class tt{constructor(e){a(this,"assets");a(this,"speed",.01);a(this,"row",0);a(this,"stage",0);a(this,"max_row",12);a(this,"repeat",!0);a(this,"song");a(this,"song_id",null);a(this,"tiles",[]);a(this,"audio_loader",new te);a(this,"audio_listener",new se);a(this,"audio");a(this,"effects",{});a(this,"tile_queue",[]);this.app=e}async init(){this.audio=new ie(this.audio_listener),await this.loadEffect("/games/paniotiles/sounds/fail.ogg","fail")}async loadEffect(e,t){const s=await this.audio_loader.loadAsync(e);return this.effects[t]=s,this}async playEffect(e){try{this.stopEffect(),this.audio.setBuffer(this.effects[e]),this.audio.play()}catch(t){console.error("Failed to stop and play a effect",t)}}async stopEffect(){this.audio.source&&this.audio.stop()}createTiles(){let e=5;for(let t=0;t<6;t++)this.tiles.push(new et(t,e,this.assets)),e+=2}async load(e){return this.audio.source&&await this.audio.stop(),this.song=JSON.parse(JSON.stringify(e)),(!this.song_id||this.song_id!==this.song.id)&&(this.song_id=this.song.id,await this.loadEffect(`/games/paniotiles/${this.song.file}`,"active")),this.stage=0,this.loadStage(0),setTimeout(()=>this.playEffect("active"),this.song.start_delay),this}loadStage(e){this.row=0,this.tile_queue=this.song.stages[e].path,this.max_row=this.song.stages[e].path.length,this.speed=this.song.stages[e].speed;let t=5;for(const s of this.tiles)s.position.y=t,t+=2,s.visible=!0;this.app.emit("stage","next",{stage:this.stage}),this.preload()}preload(){for(const e of this.tiles){let t=this.tile_queue.pop();if(!!t)for(let s=0;s<3;s++)e.setTileState(s,t[s])}return this}process(e){this.row++;let t=this.tile_queue.pop();if(!t){if(this.row>=this.max_row){if(this.stage++,this.stage>=this.song.stages.length)return 2;this.loadStage(this.stage)}return 0}if(!e.allChildrenHidden())return 1;for(let s=0;s<3;s++)e.setTileState(s,t[s]);return e.visible=!0,0}}const st=(i,e)=>{switch(i){case d.DEFAULT:return"FAILED TO TAP";case d.DOWN:return"FAILED TO SWIPE DOWN";case d.LEFT:return"FAILED TO SWIPE LEFT";case d.RIGHT:return"FAILED TO SWIPE RIGHT";case d.UP:return"FAILED TO SWIPE UP";default:return e||"FAILED TO TAP"}},R=i=>{const e=document.querySelector("div#ingame-score > div > h3[data-score]"),t=Intl.NumberFormat();e&&(e.innerText=t.format(i))},V=i=>{const e=document.querySelector("div#ingame-score > div > div[data-bouns]");e&&(e.innerText=`${i}x`)};class it{constructor(){a(this,"fxaa");a(this,"composer");a(this,"scene",new ne);a(this,"camera",new re(75,window.innerWidth/window.innerHeight,.1,1e3));a(this,"renderer",new oe({antialias:!0}));a(this,"raycaster",new ae);a(this,"player");a(this,"bar");a(this,"bouns");a(this,"bb");a(this,"score",{bouns:1,score:0,prefect:0,bouns_cap:0});a(this,"stop",!1);a(this,"touch_event",(e,t=0)=>{var l;if(this.stop)return;const s=this.raycast(e.detail.events[t].clientX,e.detail.events[t].clientY);if(!s)return;if(s[0].object.userData.type===d.HIDDEN){console.log("Hit A Hidden object");return}if(s[0].object.userData.type!==d.DEFAULT){this.emit("hit","wrong_event",{expected:d.DEFAULT}),this.stop=!0,s[0].object.material.color=new p("#ff0000");return}const n=new P().setFromObject(s[0].object);if(!this.bb.bar.intersectsBox(n)){this.emit("hit","invaild_hit",{expected:s[0].object.userData.type}),s[0].object.material.color=new p("#ff0000"),this.stop=!0;return}const r=new k;(l=s[0].object.geometry.boundingBox)==null||l.getCenter(r);const o=s[0].object.localToWorld(r);if(this.bb.bouns.containsPoint(o)){this.emit("hit","score_bouns",{}),s[0].object.material.color=new p("#a38b00"),setTimeout(()=>{s[0].object.visible=!1},100);return}s[0].object.material.color=new p("#00ff00"),setTimeout(()=>{s[0].object.visible=!1},100),this.emit("hit","score_normal",{})});a(this,"swipe_event",e=>{var l;if(this.stop)return;const t=this.raycast(e.detail.data[0].lastMove.clientX,e.detail.data[0].lastMove.clientY);if(!t)return;if(t[0].object.userData.type===d.HIDDEN){console.log("Hit A Hidden object");return}const s=H(e.detail.data[0].lastMove.clientX,e.detail.data[0].lastMove.clientY,e.detail.events[0].clientX,e.detail.events[0].clientY);switch(t[0].object.userData.type){case d.UP:if(!(s>45&&s<135)){this.emit("hit","wrong_event",{expected:d.UP}),this.stop=!0,t[0].object.material.color=new p("#ff0000");return}break;case d.DOWN:if(!(s>255&&s<315)){this.emit("hit","wrong_event",{expected:d.DOWN}),this.stop=!0,t[0].object.material.color=new p("#ff0000");return}break;case d.LEFT:if(!(s>135&&s<225)){this.emit("hit","wrong_event",{expected:d.LEFT}),this.stop=!0,t[0].object.material.color=new p("#ff0000");return}break;case d.RIGHT:if(!(s>315&&s<360||s>0&&s<45)){this.emit("hit","wrong_event",{expected:d.RIGHT}),this.stop=!0,t[0].object.material.color=new p("#ff0000");return}break;default:{this.emit("hit","invaild_hit",{expected:t[0].object.userData.type}),t[0].object.material.color=new p("#ff0000"),this.stop=!0;return}}let n=new k;(l=t[0].object.geometry.boundingBox)==null||l.getCenter(n);let r=t[0].object.localToWorld(n),o=new P().setFromObject(t[0].object);if(!this.bb.bar.intersectsBox(o)){this.emit("hit","invaild_hit",{msg:"FAILED TO SWIPE"}),t[0].object.material.color=new p("#ff0000"),this.stop=!0;return}if(this.bb.bouns.containsPoint(r)){this.emit("hit","score_bouns",{}),t[0].object.material.color=new p("#a38b00"),setTimeout(()=>{t[0].object.visible=!1},100);return}t[0].object.material.color=new p("#00ff00"),setTimeout(()=>{t[0].object.visible=!1},100),this.emit("hit","score_normal",{})});a(this,"resize",()=>{const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.composer.setSize(e,t)});a(this,"pause",async()=>{this.stop?(this.player.audio.play(),this.stop=!1):(this.stop=!0,this.player.audio.pause())});a(this,"animate",()=>{if(requestAnimationFrame(this.animate),this.composer.render(),!this.stop){for(const e of this.player.tiles)if(!!e.visible)if(e.position.y>-3.5)e.position.y-=this.player.speed;else{switch(e.visible=!1,e.position.y=7,this.player.process(e)){case B.DONE:{this.stop=!0,this.emit("exit","song_complete",{status:"ok"});break}case B.FAIL:{this.stop=!0,this.emit("exit","failed",{status:"fail"});break}}e.visible=!0}}});this.player=new tt(this),window.addEventListener("resize",this.resize),this.renderer.domElement.addEventListener("hit",e=>{if(!this.stop)switch(e.detail.id){case"wrong_event":case"invaild_hit":case"no_objects":this.player.playEffect("fail"),I({targets:"#ingame-fail",opacity:[0,1],duration:1e3,begin:()=>{h("flex","ingame-fail");const t=document.getElementById("ingame-fail");if(!t)return;const s=t.querySelector("[data-failed-why]");!s||(s.innerText=st(e.detail.data.expected,e.detail.data.msg))},complete:async()=>{await x(2e3),document.dispatchEvent(new CustomEvent("updatescore",{detail:this.score})),h("none","ingame-fail"),y("gameover")}});break;case"score_bouns":{this.score.prefect++,this.score.bouns_cap>=10?(this.score.bouns++,this.score.bouns_cap=0,V(this.score.bouns),document.dispatchEvent(new CustomEvent("updateprogress",{detail:{value:this.score.bouns_cap}}))):(this.score.bouns_cap++,document.dispatchEvent(new CustomEvent("updateprogress",{detail:{value:this.score.bouns_cap}}))),this.score.score+=this.score.bouns*10,R(this.score.score);break}case"score_normal":{this.score.score+=this.score.bouns*10,this.score.bouns_cap=0,document.dispatchEvent(new CustomEvent("updateprogress",{detail:{value:this.score.bouns_cap}})),R(this.score.score);break}}}),this.renderer.domElement.addEventListener("stage",e=>{I({targets:"#stage-overlay",duration:300,opacity:[0,1],begin:()=>{h("flex","stage-overlay");const t=document.getElementById("stage-number");t&&(t.textContent=`${e.detail.data.stage+1}`)},complete:async()=>{await x(800),I({targets:"#stage-overlay",duration:300,opacity:[1,0],complete:()=>{h("none","stage-overlay")}})}})}),this.renderer.domElement.addEventListener("exit",async e=>{switch(e.detail.id){case"failed":this.player.playEffect("fail"),I({targets:"#ingame-fail",opacity:[0,1],duration:1e3,begin:()=>{h("flex","ingame-fail");const t=document.getElementById("ingame-fail");if(!t)return;const s=t.querySelector("[data-failed-why]");!s||(s.innerText="MISSED TILE",document.dispatchEvent(new CustomEvent("updatescore",{detail:this.score})))},complete:async()=>{await x(2e3),h("none","ingame-fail"),y("gameover")}});break;case"song_complete":this.player.stopEffect(),document.dispatchEvent(new CustomEvent("updatescore",{detail:this.score})),await x(400),y("gameover")}})}emit(e,t,s){this.renderer.domElement.dispatchEvent(new CustomEvent(e,{detail:{id:t,data:s}}))}async init(){const e=new le;this.player.assets={tile:await e.loadAsync("/games/paniotiles/models/tile.glb"),normal:await e.loadAsync("/games/paniotiles/models/default_tile.glb"),arrow:await e.loadAsync("/games/paniotiles/models/arrow.glb")},await this.player.init(),this.raycaster.layers.set(b.TILES),T.Region(this.renderer.domElement).bind(this.renderer.domElement).tap(this.touch_event).swipe(this.swipe_event,!0).double(g=>{this.touch_event(g),this.touch_event(g,1)}),this.camera.position.z=5,this.camera.layers.enable(b.TILES),this.camera.layers.enable(b.BLOOM),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.outputEncoding=ce,this.renderer.toneMapping=ue,this.renderer.shadowMap.enabled=!0;const s=new de(this.scene,this.camera);this.composer=new he(this.renderer),this.composer.setPixelRatio(window.devicePixelRatio),this.composer.addPass(s),this.composer.renderTarget1.texture.format=j,this.composer.renderTarget2.texture.format=j;const n=this.renderer.getPixelRatio();this.fxaa=new me(fe),this.fxaa.material.uniforms.resolution.value.x=1/(window.innerWidth*n),this.fxaa.material.uniforms.resolution.value.y=1/(window.innerHeight*n),this.composer.addPass(this.fxaa),this.bar=new S(new O(8,1.2),new C({color:"#000000"})),this.bar.name="Plane",this.bar.position.y=-2,this.bouns=new S(new O(4,.4),new C({color:"#0000ff"})),this.bouns.name="Plane Bouns",this.bouns.position.y=-2,this.bb={bar:new P().setFromObject(this.bar),bouns:new P().setFromObject(this.bouns)};const r=new ge(16777215,16777215,10);r.position.set(0,60,0);const o=new pe(16777215,1);o.position.set(1,1,1).normalize(),o.castShadow=!0;const l=new ye({color:"#ffffff",roughness:.2,metalness:.2}),c=new S(new O(40,40),l);c.name="Ground",c.position.z=-10,c.receiveShadow=!0,this.player.createTiles();const f=new be(new N(window.innerWidth,window.innerHeight),.5,.4,.85,!0,b.BLOOM,this.scene,this.camera);f.threshold=0,f.strength=1,f.radius=0,this.composer.addPass(f),this.scene.add(c,this.bar,this.bouns,new Ee(2236962),o,r,...this.player.tiles)}raycast(e,t){const s=new N(e/window.innerWidth*2-1,-(t/window.innerHeight)*2+1);this.raycaster.setFromCamera(s,this.camera);const n=this.raycaster.intersectObjects(this.scene.children);if(n.length===0){this.emit("hit","no_objects",{msg:"FAILED TO HIT TILE"}),this.stop=!0;return}return n}async run(){return v("start"),await this.init(),this.stop=!0,this.toggleCanvas(),document.body.appendChild(this.renderer.domElement),this.animate(),v("end"),this}toggleCanvas(){this.renderer.domElement.style.display==="none"?this.renderer.domElement.style.display="block":this.renderer.domElement.style.display="none"}async load(e){v("start"),this.score.score=0,this.score.bouns=1,this.score.prefect=0,this.score.bouns_cap=0,document.dispatchEvent(new CustomEvent("updateprogress",{detail:{value:0}})),document.dispatchEvent(new CustomEvent("updatescore",{detail:this.score})),R(0),V(1),await this.player.load(e),v("end"),this.stop=!1}}var E=[{id:0,name:"Bad Manners",author:"Riff Kitten",file:"sounds/bad_manners.mp3",img:"images/riff_kitten_bad_manners.jpg",start_delay:1600,stages:[{speed:.06,path:[[1,0,1],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[0,0,1],[4,0,0],[0,0,1],[0,1,0],[1,0,0],[3,0,0],[1,0,0],[0,0,1],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0]]},{speed:.06,path:[[0,0,1],[0,1,0],[1,0,0],[1,0,0],[1,0,0],[1,0,1],[0,0,1],[1,0,0],[1,0,0],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[1,1,0],[1,0,0],[0,1,1],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[1,1,0],[1,0,0],[0,1,1],[0,1,0],[1,0,1],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[2,0,0],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[1,1,0],[1,0,0],[0,1,1],[0,1,0],[1,0,1],[0,0,1],[1,0,0],[1,0,0],[0,0,1],[4,0,0],[0,0,1],[0,0,1],[4,0,0],[0,0,1],[0,1,0],[1,0,0],[0,0,1],[0,1,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0],[1,0,0],[0,0,4],[0,1,0],[1,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0,0]]}]}];let Z;const _=new it,u={location:"home",song_id:0,bind:(i,e)=>{T.Region(i).bind(i).tap(e)},unbind:i=>{T.Region(i).unbind(i,"tap")},loading:!1,score:{prefects:0,count:0}};document.addEventListener("updatescore",i=>{u.score.count=i.detail.score,u.score.prefects=i.detail.prefect});document.addEventListener("updateprogress",i=>{Z.progress=i.detail.value/10});document.addEventListener("loading",i=>{if(i.detail.id==="start"){if(u.loading)return;I({targets:"#loading-overlay",opacity:[0,1],easing:"linear",duration:200,begin:()=>{h("flex","loading-overlay"),u.loading=!0}})}else if(i.detail.id==="end"){if(!u.loading)return;I({targets:"#loading-overlay",opacity:[1,0],easing:"linear",duration:200,complete:()=>{h("none","loading-overlay"),u.loading=!1}})}});document.addEventListener("location",i=>{let e=!1;const t=u.location;t!==i.detail.location&&(u.location=i.detail.location,e=!0),i.detail.song_id!==void 0&&u.song_id!==i.detail.song_id&&(u.song_id=i.detail.song_id,e=!0),e&&K(t)});async function K(i){const e=document.querySelector(".main-menu-content");if(!!e){if(i&&i!==u.location){if(i==="home"){const t=document.getElementById("#play-game");t&&u.unbind(t)}else if(i==="game")v("start"),await x(200),h("flex","main-menu"),h("none","ingame-fab"),h("none","ingame-score"),_.toggleCanvas(),v("end");else if(i==="songlist")for(const t of document.querySelectorAll("[data-song-list-play]"))u.unbind(t);else i==="gameover"&&(h("none","game-over"),h("flex","main-menu"));for(const t of e.children)e.removeChild(t)}switch(u.location){case"home":{const t=document.querySelector("[data-main-content]");if(!t)return;let s=E[u.song_id];const n=t.content.cloneNode(!0),r=n.querySelector("#song-name");r&&(r.innerText=s.name);const o=n.querySelector("#song-author");o&&(o.innerText=s.author);const l=n.querySelector("[data-song-imgsrc]");l&&(s.img.length>0?(l.parentElement.style.backgroundImage=`url(/games/paniotiles/${s.img})`,l.style.display="none"):l.src=`https://via.placeholder.com/230.webp?text=${encodeURIComponent(s.name)}`);const c=n.querySelector("#play-game");u.bind(c,()=>y("game")),e.appendChild(n);break}case"songlist":{const t=document.querySelector("[data-song-list]");if(!t)return;const s=document.querySelector("[data-song-item]");if(!s)return;const n=t.content.cloneNode(!0),r=n.querySelector("ul");if(!r)return;for(const o of E){const l=s.content.cloneNode(!0),c=l.querySelector("li.mdc-list-item");c.setAttribute("data-song-id",o.id.toString());const f=c.querySelector("[data-item-title]");f&&(f.innerText=o.name);const g=c.querySelector("[data-item-author]");g&&(g.innerText=o.author);const m=c.querySelector("[data-item-img]");m&&(o.img.length>0?(m.style.backgroundImage=`url(/games/paniotiles/${o.img})`,m.children[0].style.display="none"):m.children[0].src=`https://via.placeholder.com/56.webp?text=${encodeURIComponent(o.name)}`);let D=c.querySelector("[data-song-list-play]");u.bind(D,()=>{let w=c.getAttribute("data-song-id");w!==null&&(console.log(w),y("home",Number(w)))}),r.appendChild(l)}e.appendChild(n);break}case"game":{document.dispatchEvent(new CustomEvent("loading",{detail:{id:"start"}})),await x(200),h("none","main-menu"),h("block","ingame-fab"),h("flex","ingame-score"),_.toggleCanvas(),await _.load(E[u.song_id]);break}case"gameover":{h("none","main-menu"),h("flex","game-over");const t=document.getElementById("game-over");if(!t){console.error("Missing Element (game-over)");return}const s=t.querySelector("h3[data-song-title]");s&&(s.innerText=E[u.song_id].name);const n=t.querySelector("div[data-song-author]");n&&(n.innerText=E[u.song_id].author);const r=t.querySelector("div.song-img");r&&(E[u.song_id].img.length>0?(r.style.backgroundImage=`url(/games/paniotiles/${E[u.song_id].img})`,r.children[0].style.display="none"):(r.children[0].style.display="block",r.children[0].src=`https://via.placeholder.com/230.webp?text=${encodeURIComponent(E[u.song_id].name)}`));const o=t.querySelector("h3[data-score]"),l=Intl.NumberFormat();o&&(o.innerText=l.format(u.score.count));break}}}}window.addEventListener("load",async()=>{window.addEventListener("fullscreenchange",g=>{const m=document.getElementById("fullscreen-access");if(!m)return;const D=m.querySelector("i.material-icons.mdc-list-item__graphic"),w=m.querySelector("span.mdc-list-item__text");!D||!w||(document.fullscreenElement?(D.innerText="fullscreen_exit",w.innerText="Exit Fullscreen"):(D.innerText="fullscreen",w.innerText="Fullscreen"))});let i=document.getElementById("build-version");i&&(i.innerText="v1.0.0-beta");const e=we.attachTo(document.querySelector(".mdc-list"));e.wrapFocus=!0;const t=ve.attachTo(document.querySelector(".mdc-drawer")),s=new Ie(document.querySelector(".mdc-icon-button"));s.unbounded=!0,Z=new Te(document.querySelector(".mdc-linear-progress"));const n=new xe(document.querySelector(".mdc-dialog"));n.initialSyncWithDOM(),n.listen("MDCDialog:closed",g=>{g.detail.action==="yes"&&document.body.requestFullscreen()});const r=document.getElementById("app-songlist"),o=document.getElementById("app-home"),l=document.getElementById("ingame-fab"),c=document.getElementById("game-resume"),f=document.getElementById("game-exit");u.bind(r,()=>y("songlist")),u.bind(o,()=>y("home")),u.bind(l,()=>{h("flex","ingame-options"),_.pause()}),u.bind(c,()=>{h("none","ingame-options"),_.pause()}),u.bind(f,()=>{h("none","ingame-options"),y("home")}),u.bind(document.getElementById("fullscreen-access"),g=>{document.fullscreenElement?document.exitFullscreen():document.body.requestFullscreen()}),u.bind(document.querySelector(".mdc-drawer-scrim"),()=>{t.open=!1}),u.bind(document.getElementById("play-retry"),()=>y("game")),u.bind(document.getElementById("play-continue"),()=>y("home")),u.bind(document.getElementById("app-settings"),()=>{t.open=!0}),v("start"),await _.run(),K(),document.fullscreenElement||n.open()});
